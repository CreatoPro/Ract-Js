{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"../../utils/core\");\n\nvar _epubcfi = _interopRequireDefault(require(\"../../epubcfi\"));\n\nvar _contents = _interopRequireDefault(require(\"../../contents\"));\n\nvar _constants = require(\"../../utils/constants\");\n\nvar _marksPane = require(\"marks-pane\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nclass IframeView {\n  constructor(section, options) {\n    this.settings = (0, _core.extend)({\n      ignoreClass: \"\",\n      axis: undefined,\n      //options.layout && options.layout.props.flow === \"scrolled\" ? \"vertical\" : \"horizontal\",\n      direction: undefined,\n      width: 0,\n      height: 0,\n      layout: undefined,\n      globalLayoutProperties: {},\n      method: undefined,\n      forceRight: false,\n      allowScriptedContent: false,\n      allowPopups: false\n    }, options || {});\n    this.id = \"epubjs-view-\" + (0, _core.uuid)();\n    this.section = section;\n    this.index = section.index;\n    this.element = this.container(this.settings.axis);\n    this.added = false;\n    this.displayed = false;\n    this.rendered = false; // this.width  = this.settings.width;\n    // this.height = this.settings.height;\n\n    this.fixedWidth = 0;\n    this.fixedHeight = 0; // Blank Cfi for Parsing\n\n    this.epubcfi = new _epubcfi.default();\n    this.layout = this.settings.layout; // Dom events to listen for\n    // this.listenedEvents = [\"keydown\", \"keyup\", \"keypressed\", \"mouseup\", \"mousedown\", \"click\", \"touchend\", \"touchstart\"];\n\n    this.pane = undefined;\n    this.highlights = {};\n    this.underlines = {};\n    this.marks = {};\n  }\n\n  container(axis) {\n    var element = document.createElement(\"div\");\n    element.classList.add(\"epub-view\"); // this.element.style.minHeight = \"100px\";\n\n    element.style.height = \"0px\";\n    element.style.width = \"0px\";\n    element.style.overflow = \"hidden\";\n    element.style.position = \"relative\";\n    element.style.display = \"block\";\n\n    if (axis && axis == \"horizontal\") {\n      element.style.flex = \"none\";\n    } else {\n      element.style.flex = \"initial\";\n    }\n\n    return element;\n  }\n\n  create() {\n    if (this.iframe) {\n      return this.iframe;\n    }\n\n    if (!this.element) {\n      this.element = this.createContainer();\n    }\n\n    this.iframe = document.createElement(\"iframe\");\n    this.iframe.id = this.id;\n    this.iframe.scrolling = \"no\"; // Might need to be removed: breaks ios width calculations\n\n    this.iframe.style.overflow = \"hidden\";\n    this.iframe.seamless = \"seamless\"; // Back up if seamless isn't supported\n\n    this.iframe.style.border = \"none\"; // sandbox\n\n    this.iframe.sandbox = \"allow-same-origin\";\n\n    if (this.settings.allowScriptedContent) {\n      this.iframe.sandbox += \" allow-scripts\";\n    }\n\n    if (this.settings.allowPopups) {\n      this.iframe.sandbox += \" allow-popups\";\n    }\n\n    this.iframe.setAttribute(\"enable-annotation\", \"true\");\n    this.resizing = true; // this.iframe.style.display = \"none\";\n\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.iframe.style.width = \"0\";\n    this.iframe.style.height = \"0\";\n    this._width = 0;\n    this._height = 0;\n    this.element.setAttribute(\"ref\", this.index);\n    this.added = true;\n    this.elementBounds = (0, _core.bounds)(this.element); // if(width || height){\n    //   this.resize(width, height);\n    // } else if(this.width && this.height){\n    //   this.resize(this.width, this.height);\n    // } else {\n    //   this.iframeBounds = bounds(this.iframe);\n    // }\n\n    if (\"srcdoc\" in this.iframe) {\n      this.supportsSrcdoc = true;\n    } else {\n      this.supportsSrcdoc = false;\n    }\n\n    if (!this.settings.method) {\n      this.settings.method = this.supportsSrcdoc ? \"srcdoc\" : \"write\";\n    }\n\n    return this.iframe;\n  }\n\n  render(request, show) {\n    // view.onLayout = this.layout.format.bind(this.layout);\n    this.create(); // Fit to size of the container, apply padding\n\n    this.size();\n\n    if (!this.sectionRender) {\n      this.sectionRender = this.section.render(request);\n    } // Render Chain\n\n\n    return this.sectionRender.then(function (contents) {\n      return this.load(contents);\n    }.bind(this)).then(function () {\n      // find and report the writingMode axis\n      let writingMode = this.contents.writingMode(); // Set the axis based on the flow and writing mode\n\n      let axis;\n\n      if (this.settings.flow === \"scrolled\") {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"horizontal\" : \"vertical\";\n      } else {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"vertical\" : \"horizontal\";\n      }\n\n      if (writingMode.indexOf(\"vertical\") === 0 && this.settings.flow === \"paginated\") {\n        this.layout.delta = this.layout.height;\n      }\n\n      this.setAxis(axis);\n      this.emit(_constants.EVENTS.VIEWS.AXIS, axis);\n      this.setWritingMode(writingMode);\n      this.emit(_constants.EVENTS.VIEWS.WRITING_MODE, writingMode); // apply the layout function to the contents\n\n      this.layout.format(this.contents, this.section, this.axis); // Listen for events that require an expansion of the iframe\n\n      this.addListeners();\n      return new Promise((resolve, reject) => {\n        // Expand the iframe to the full size of the content\n        this.expand();\n\n        if (this.settings.forceRight) {\n          this.element.style.marginLeft = this.width() + \"px\";\n        }\n\n        resolve();\n      });\n    }.bind(this), function (e) {\n      this.emit(_constants.EVENTS.VIEWS.LOAD_ERROR, e);\n      return new Promise((resolve, reject) => {\n        reject(e);\n      });\n    }.bind(this)).then(function () {\n      this.emit(_constants.EVENTS.VIEWS.RENDERED, this.section);\n    }.bind(this));\n  }\n\n  reset() {\n    if (this.iframe) {\n      this.iframe.style.width = \"0\";\n      this.iframe.style.height = \"0\";\n      this._width = 0;\n      this._height = 0;\n      this._textWidth = undefined;\n      this._contentWidth = undefined;\n      this._textHeight = undefined;\n      this._contentHeight = undefined;\n    }\n\n    this._needsReframe = true;\n  } // Determine locks base on settings\n\n\n  size(_width, _height) {\n    var width = _width || this.settings.width;\n    var height = _height || this.settings.height;\n\n    if (this.layout.name === \"pre-paginated\") {\n      this.lock(\"both\", width, height);\n    } else if (this.settings.axis === \"horizontal\") {\n      this.lock(\"height\", width, height);\n    } else {\n      this.lock(\"width\", width, height);\n    }\n\n    this.settings.width = width;\n    this.settings.height = height;\n  } // Lock an axis to element dimensions, taking borders into account\n\n\n  lock(what, width, height) {\n    var elBorders = (0, _core.borders)(this.element);\n    var iframeBorders;\n\n    if (this.iframe) {\n      iframeBorders = (0, _core.borders)(this.iframe);\n    } else {\n      iframeBorders = {\n        width: 0,\n        height: 0\n      };\n    }\n\n    if (what == \"width\" && (0, _core.isNumber)(width)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width; // this.resize(this.lockedWidth, width); //  width keeps ratio correct\n    }\n\n    if (what == \"height\" && (0, _core.isNumber)(height)) {\n      this.lockedHeight = height - elBorders.height - iframeBorders.height; // this.resize(width, this.lockedHeight);\n    }\n\n    if (what === \"both\" && (0, _core.isNumber)(width) && (0, _core.isNumber)(height)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width;\n      this.lockedHeight = height - elBorders.height - iframeBorders.height; // this.resize(this.lockedWidth, this.lockedHeight);\n    }\n\n    if (this.displayed && this.iframe) {\n      // this.contents.layout();\n      this.expand();\n    }\n  } // Resize a single axis based on content dimensions\n\n\n  expand(force) {\n    var width = this.lockedWidth;\n    var height = this.lockedHeight;\n    var columns;\n    var textWidth, textHeight;\n    if (!this.iframe || this._expanding) return;\n    this._expanding = true;\n\n    if (this.layout.name === \"pre-paginated\") {\n      width = this.layout.columnWidth;\n      height = this.layout.height;\n    } // Expand Horizontally\n    else if (this.settings.axis === \"horizontal\") {\n      // Get the width of the text\n      width = this.contents.textWidth();\n\n      if (width % this.layout.pageWidth > 0) {\n        width = Math.ceil(width / this.layout.pageWidth) * this.layout.pageWidth;\n      }\n\n      if (this.settings.forceEvenPages) {\n        columns = width / this.layout.pageWidth;\n\n        if (this.layout.divisor > 1 && this.layout.name === \"reflowable\" && columns % 2 > 0) {\n          // add a blank page\n          width += this.layout.pageWidth;\n        }\n      }\n    } // Expand Vertically\n    else if (this.settings.axis === \"vertical\") {\n      height = this.contents.textHeight();\n\n      if (this.settings.flow === \"paginated\" && height % this.layout.height > 0) {\n        height = Math.ceil(height / this.layout.height) * this.layout.height;\n      }\n    } // Only Resize if dimensions have changed or\n    // if Frame is still hidden, so needs reframing\n\n\n    if (this._needsReframe || width != this._width || height != this._height) {\n      this.reframe(width, height);\n    }\n\n    this._expanding = false;\n  }\n\n  reframe(width, height) {\n    var size;\n\n    if ((0, _core.isNumber)(width)) {\n      this.element.style.width = width + \"px\";\n      this.iframe.style.width = width + \"px\";\n      this._width = width;\n    }\n\n    if ((0, _core.isNumber)(height)) {\n      this.element.style.height = height + \"px\";\n      this.iframe.style.height = height + \"px\";\n      this._height = height;\n    }\n\n    let widthDelta = this.prevBounds ? width - this.prevBounds.width : width;\n    let heightDelta = this.prevBounds ? height - this.prevBounds.height : height;\n    size = {\n      width: width,\n      height: height,\n      widthDelta: widthDelta,\n      heightDelta: heightDelta\n    };\n    this.pane && this.pane.render();\n    requestAnimationFrame(() => {\n      let mark;\n\n      for (let m in this.marks) {\n        if (this.marks.hasOwnProperty(m)) {\n          mark = this.marks[m];\n          this.placeMark(mark.element, mark.range);\n        }\n      }\n    });\n    this.onResize(this, size);\n    this.emit(_constants.EVENTS.VIEWS.RESIZED, size);\n    this.prevBounds = size;\n    this.elementBounds = (0, _core.bounds)(this.element);\n  }\n\n  load(contents) {\n    var loading = new _core.defer();\n    var loaded = loading.promise;\n\n    if (!this.iframe) {\n      loading.reject(new Error(\"No Iframe Available\"));\n      return loaded;\n    }\n\n    this.iframe.onload = function (event) {\n      this.onLoad(event, loading);\n    }.bind(this);\n\n    if (this.settings.method === \"blobUrl\") {\n      this.blobUrl = (0, _core.createBlobUrl)(contents, \"application/xhtml+xml\");\n      this.iframe.src = this.blobUrl;\n      this.element.appendChild(this.iframe);\n    } else if (this.settings.method === \"srcdoc\") {\n      this.iframe.srcdoc = contents;\n      this.element.appendChild(this.iframe);\n    } else {\n      this.element.appendChild(this.iframe);\n      this.document = this.iframe.contentDocument;\n\n      if (!this.document) {\n        loading.reject(new Error(\"No Document Available\"));\n        return loaded;\n      }\n\n      this.iframe.contentDocument.open(); // For Cordova windows platform\n\n      if (window.MSApp && MSApp.execUnsafeLocalFunction) {\n        var outerThis = this;\n        MSApp.execUnsafeLocalFunction(function () {\n          outerThis.iframe.contentDocument.write(contents);\n        });\n      } else {\n        this.iframe.contentDocument.write(contents);\n      }\n\n      this.iframe.contentDocument.close();\n    }\n\n    return loaded;\n  }\n\n  onLoad(event, promise) {\n    this.window = this.iframe.contentWindow;\n    this.document = this.iframe.contentDocument;\n    this.contents = new _contents.default(this.document, this.document.body, this.section.cfiBase, this.section.index);\n    this.rendering = false;\n    var link = this.document.querySelector(\"link[rel='canonical']\");\n\n    if (link) {\n      link.setAttribute(\"href\", this.section.canonical);\n    } else {\n      link = this.document.createElement(\"link\");\n      link.setAttribute(\"rel\", \"canonical\");\n      link.setAttribute(\"href\", this.section.canonical);\n      this.document.querySelector(\"head\").appendChild(link);\n    }\n\n    this.contents.on(_constants.EVENTS.CONTENTS.EXPAND, () => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    this.contents.on(_constants.EVENTS.CONTENTS.RESIZE, e => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    promise.resolve(this.contents);\n  }\n\n  setLayout(layout) {\n    this.layout = layout;\n\n    if (this.contents) {\n      this.layout.format(this.contents);\n      this.expand();\n    }\n  }\n\n  setAxis(axis) {\n    this.settings.axis = axis;\n\n    if (axis == \"horizontal\") {\n      this.element.style.flex = \"none\";\n    } else {\n      this.element.style.flex = \"initial\";\n    }\n\n    this.size();\n  }\n\n  setWritingMode(mode) {\n    // this.element.style.writingMode = writingMode;\n    this.writingMode = mode;\n  }\n\n  addListeners() {//TODO: Add content listeners for expanding\n  }\n\n  removeListeners(layoutFunc) {//TODO: remove content listeners for expanding\n  }\n\n  display(request) {\n    var displayed = new _core.defer();\n\n    if (!this.displayed) {\n      this.render(request).then(function () {\n        this.emit(_constants.EVENTS.VIEWS.DISPLAYED, this);\n        this.onDisplayed(this);\n        this.displayed = true;\n        displayed.resolve(this);\n      }.bind(this), function (err) {\n        displayed.reject(err, this);\n      });\n    } else {\n      displayed.resolve(this);\n    }\n\n    return displayed.promise;\n  }\n\n  show() {\n    this.element.style.visibility = \"visible\";\n\n    if (this.iframe) {\n      this.iframe.style.visibility = \"visible\"; // Remind Safari to redraw the iframe\n\n      this.iframe.style.transform = \"translateZ(0)\";\n      this.iframe.offsetWidth;\n      this.iframe.style.transform = null;\n    }\n\n    this.emit(_constants.EVENTS.VIEWS.SHOWN, this);\n  }\n\n  hide() {\n    // this.iframe.style.display = \"none\";\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.stopExpanding = true;\n    this.emit(_constants.EVENTS.VIEWS.HIDDEN, this);\n  }\n\n  offset() {\n    return {\n      top: this.element.offsetTop,\n      left: this.element.offsetLeft\n    };\n  }\n\n  width() {\n    return this._width;\n  }\n\n  height() {\n    return this._height;\n  }\n\n  position() {\n    return this.element.getBoundingClientRect();\n  }\n\n  locationOf(target) {\n    var parentPos = this.iframe.getBoundingClientRect();\n    var targetPos = this.contents.locationOf(target, this.settings.ignoreClass);\n    return {\n      \"left\": targetPos.left,\n      \"top\": targetPos.top\n    };\n  }\n\n  onDisplayed(view) {// Stub, override with a custom functions\n  }\n\n  onResize(view, e) {// Stub, override with a custom functions\n  }\n\n  bounds(force) {\n    if (force || !this.elementBounds) {\n      this.elementBounds = (0, _core.bounds)(this.element);\n    }\n\n    return this.elementBounds;\n  }\n\n  highlight(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n    let className = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : \"epubjs-hl\";\n    let styles = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};\n\n    if (!this.contents) {\n      return;\n    }\n\n    const attributes = Object.assign({\n      \"fill\": \"yellow\",\n      \"fill-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n\n    let emitter = () => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    data[\"epubcfi\"] = cfiRange;\n\n    if (!this.pane) {\n      this.pane = new _marksPane.Pane(this.iframe, this.element);\n    }\n\n    let m = new _marksPane.Highlight(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.highlights[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n\n    return h;\n  }\n\n  underline(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n    let className = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : \"epubjs-ul\";\n    let styles = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};\n\n    if (!this.contents) {\n      return;\n    }\n\n    const attributes = Object.assign({\n      \"stroke\": \"black\",\n      \"stroke-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n\n    let emitter = () => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    data[\"epubcfi\"] = cfiRange;\n\n    if (!this.pane) {\n      this.pane = new _marksPane.Pane(this.iframe, this.element);\n    }\n\n    let m = new _marksPane.Underline(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.underlines[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n\n    return h;\n  }\n\n  mark(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n\n    if (!this.contents) {\n      return;\n    }\n\n    if (cfiRange in this.marks) {\n      let item = this.marks[cfiRange];\n      return item;\n    }\n\n    let range = this.contents.range(cfiRange);\n\n    if (!range) {\n      return;\n    }\n\n    let container = range.commonAncestorContainer;\n    let parent = container.nodeType === 1 ? container : container.parentNode;\n\n    let emitter = e => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    if (range.collapsed && container.nodeType === 1) {\n      range = new Range();\n      range.selectNodeContents(container);\n    } else if (range.collapsed) {\n      // Webkit doesn't like collapsed ranges\n      range = new Range();\n      range.selectNodeContents(parent);\n    }\n\n    let mark = this.document.createElement(\"a\");\n    mark.setAttribute(\"ref\", \"epubjs-mk\");\n    mark.style.position = \"absolute\";\n    mark.dataset[\"epubcfi\"] = cfiRange;\n\n    if (data) {\n      Object.keys(data).forEach(key => {\n        mark.dataset[key] = data[key];\n      });\n    }\n\n    if (cb) {\n      mark.addEventListener(\"click\", cb);\n      mark.addEventListener(\"touchstart\", cb);\n    }\n\n    mark.addEventListener(\"click\", emitter);\n    mark.addEventListener(\"touchstart\", emitter);\n    this.placeMark(mark, range);\n    this.element.appendChild(mark);\n    this.marks[cfiRange] = {\n      \"element\": mark,\n      \"range\": range,\n      \"listeners\": [emitter, cb]\n    };\n    return parent;\n  }\n\n  placeMark(element, range) {\n    let top, right, left;\n\n    if (this.layout.name === \"pre-paginated\" || this.settings.axis !== \"horizontal\") {\n      let pos = range.getBoundingClientRect();\n      top = pos.top;\n      right = pos.right;\n    } else {\n      // Element might break columns, so find the left most element\n      let rects = range.getClientRects();\n      let rect;\n\n      for (var i = 0; i != rects.length; i++) {\n        rect = rects[i];\n\n        if (!left || rect.left < left) {\n          left = rect.left; // right = rect.right;\n\n          right = Math.ceil(left / this.layout.props.pageWidth) * this.layout.props.pageWidth - this.layout.gap / 2;\n          top = rect.top;\n        }\n      }\n    }\n\n    element.style.top = `${top}px`;\n    element.style.left = `${right}px`;\n  }\n\n  unhighlight(cfiRange) {\n    let item;\n\n    if (cfiRange in this.highlights) {\n      item = this.highlights[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.highlights[cfiRange];\n    }\n  }\n\n  ununderline(cfiRange) {\n    let item;\n\n    if (cfiRange in this.underlines) {\n      item = this.underlines[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.underlines[cfiRange];\n    }\n  }\n\n  unmark(cfiRange) {\n    let item;\n\n    if (cfiRange in this.marks) {\n      item = this.marks[cfiRange];\n      this.element.removeChild(item.element);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.marks[cfiRange];\n    }\n  }\n\n  destroy() {\n    for (let cfiRange in this.highlights) {\n      this.unhighlight(cfiRange);\n    }\n\n    for (let cfiRange in this.underlines) {\n      this.ununderline(cfiRange);\n    }\n\n    for (let cfiRange in this.marks) {\n      this.unmark(cfiRange);\n    }\n\n    if (this.blobUrl) {\n      (0, _core.revokeBlobUrl)(this.blobUrl);\n    }\n\n    if (this.displayed) {\n      this.displayed = false;\n      this.removeListeners();\n      this.contents.destroy();\n      this.stopExpanding = true;\n      this.element.removeChild(this.iframe);\n\n      if (this.pane) {\n        this.pane.element.remove();\n        this.pane = undefined;\n      }\n\n      this.iframe = undefined;\n      this.contents = undefined;\n      this._textWidth = null;\n      this._textHeight = null;\n      this._width = null;\n      this._height = null;\n    } // this.element.style.height = \"0px\";\n    // this.element.style.width = \"0px\";\n\n  }\n\n}\n\n(0, _eventEmitter.default)(IframeView.prototype);\nvar _default = IframeView;\nexports.default = _default;","map":{"version":3,"sources":["S:/REACT/Ract-Js/Frlnce/node_modules/epubjs/lib/managers/views/iframe.js"],"names":["Object","defineProperty","exports","value","default","_eventEmitter","_interopRequireDefault","require","_core","_epubcfi","_contents","_constants","_marksPane","obj","__esModule","IframeView","constructor","section","options","settings","extend","ignoreClass","axis","undefined","direction","width","height","layout","globalLayoutProperties","method","forceRight","allowScriptedContent","allowPopups","id","uuid","index","element","container","added","displayed","rendered","fixedWidth","fixedHeight","epubcfi","pane","highlights","underlines","marks","document","createElement","classList","add","style","overflow","position","display","flex","create","iframe","createContainer","scrolling","seamless","border","sandbox","setAttribute","resizing","visibility","_width","_height","elementBounds","bounds","supportsSrcdoc","render","request","show","size","sectionRender","then","contents","load","bind","writingMode","flow","indexOf","delta","setAxis","emit","EVENTS","VIEWS","AXIS","setWritingMode","WRITING_MODE","format","addListeners","Promise","resolve","reject","expand","marginLeft","e","LOAD_ERROR","RENDERED","reset","_textWidth","_contentWidth","_textHeight","_contentHeight","_needsReframe","name","lock","what","elBorders","borders","iframeBorders","isNumber","lockedWidth","lockedHeight","force","columns","textWidth","textHeight","_expanding","columnWidth","pageWidth","Math","ceil","forceEvenPages","divisor","reframe","widthDelta","prevBounds","heightDelta","requestAnimationFrame","mark","m","hasOwnProperty","placeMark","range","onResize","RESIZED","loading","defer","loaded","promise","Error","onload","event","onLoad","blobUrl","createBlobUrl","src","appendChild","srcdoc","contentDocument","open","window","MSApp","execUnsafeLocalFunction","outerThis","write","close","contentWindow","body","cfiBase","rendering","link","querySelector","canonical","on","CONTENTS","EXPAND","RESIZE","setLayout","mode","removeListeners","layoutFunc","DISPLAYED","onDisplayed","err","transform","offsetWidth","SHOWN","hide","stopExpanding","HIDDEN","offset","top","offsetTop","left","offsetLeft","getBoundingClientRect","locationOf","target","parentPos","targetPos","view","highlight","cfiRange","data","cb","className","styles","attributes","assign","emitter","MARK_CLICKED","Pane","Highlight","h","addMark","addEventListener","underline","Underline","item","commonAncestorContainer","parent","nodeType","parentNode","collapsed","Range","selectNodeContents","dataset","keys","forEach","key","right","pos","rects","getClientRects","rect","i","length","props","gap","unhighlight","removeMark","listeners","l","removeEventListener","ununderline","unmark","removeChild","destroy","revokeBlobUrl","remove","prototype","_default"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"../../utils/core\");\n\nvar _epubcfi = _interopRequireDefault(require(\"../../epubcfi\"));\n\nvar _contents = _interopRequireDefault(require(\"../../contents\"));\n\nvar _constants = require(\"../../utils/constants\");\n\nvar _marksPane = require(\"marks-pane\");\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nclass IframeView {\n  constructor(section, options) {\n    this.settings = (0, _core.extend)({\n      ignoreClass: \"\",\n      axis: undefined,\n      //options.layout && options.layout.props.flow === \"scrolled\" ? \"vertical\" : \"horizontal\",\n      direction: undefined,\n      width: 0,\n      height: 0,\n      layout: undefined,\n      globalLayoutProperties: {},\n      method: undefined,\n      forceRight: false,\n      allowScriptedContent: false,\n      allowPopups: false\n    }, options || {});\n    this.id = \"epubjs-view-\" + (0, _core.uuid)();\n    this.section = section;\n    this.index = section.index;\n    this.element = this.container(this.settings.axis);\n    this.added = false;\n    this.displayed = false;\n    this.rendered = false; // this.width  = this.settings.width;\n    // this.height = this.settings.height;\n\n    this.fixedWidth = 0;\n    this.fixedHeight = 0; // Blank Cfi for Parsing\n\n    this.epubcfi = new _epubcfi.default();\n    this.layout = this.settings.layout; // Dom events to listen for\n    // this.listenedEvents = [\"keydown\", \"keyup\", \"keypressed\", \"mouseup\", \"mousedown\", \"click\", \"touchend\", \"touchstart\"];\n\n    this.pane = undefined;\n    this.highlights = {};\n    this.underlines = {};\n    this.marks = {};\n  }\n\n  container(axis) {\n    var element = document.createElement(\"div\");\n    element.classList.add(\"epub-view\"); // this.element.style.minHeight = \"100px\";\n\n    element.style.height = \"0px\";\n    element.style.width = \"0px\";\n    element.style.overflow = \"hidden\";\n    element.style.position = \"relative\";\n    element.style.display = \"block\";\n\n    if (axis && axis == \"horizontal\") {\n      element.style.flex = \"none\";\n    } else {\n      element.style.flex = \"initial\";\n    }\n\n    return element;\n  }\n\n  create() {\n    if (this.iframe) {\n      return this.iframe;\n    }\n\n    if (!this.element) {\n      this.element = this.createContainer();\n    }\n\n    this.iframe = document.createElement(\"iframe\");\n    this.iframe.id = this.id;\n    this.iframe.scrolling = \"no\"; // Might need to be removed: breaks ios width calculations\n\n    this.iframe.style.overflow = \"hidden\";\n    this.iframe.seamless = \"seamless\"; // Back up if seamless isn't supported\n\n    this.iframe.style.border = \"none\"; // sandbox\n\n    this.iframe.sandbox = \"allow-same-origin\";\n\n    if (this.settings.allowScriptedContent) {\n      this.iframe.sandbox += \" allow-scripts\";\n    }\n\n    if (this.settings.allowPopups) {\n      this.iframe.sandbox += \" allow-popups\";\n    }\n\n    this.iframe.setAttribute(\"enable-annotation\", \"true\");\n    this.resizing = true; // this.iframe.style.display = \"none\";\n\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.iframe.style.width = \"0\";\n    this.iframe.style.height = \"0\";\n    this._width = 0;\n    this._height = 0;\n    this.element.setAttribute(\"ref\", this.index);\n    this.added = true;\n    this.elementBounds = (0, _core.bounds)(this.element); // if(width || height){\n    //   this.resize(width, height);\n    // } else if(this.width && this.height){\n    //   this.resize(this.width, this.height);\n    // } else {\n    //   this.iframeBounds = bounds(this.iframe);\n    // }\n\n    if (\"srcdoc\" in this.iframe) {\n      this.supportsSrcdoc = true;\n    } else {\n      this.supportsSrcdoc = false;\n    }\n\n    if (!this.settings.method) {\n      this.settings.method = this.supportsSrcdoc ? \"srcdoc\" : \"write\";\n    }\n\n    return this.iframe;\n  }\n\n  render(request, show) {\n    // view.onLayout = this.layout.format.bind(this.layout);\n    this.create(); // Fit to size of the container, apply padding\n\n    this.size();\n\n    if (!this.sectionRender) {\n      this.sectionRender = this.section.render(request);\n    } // Render Chain\n\n\n    return this.sectionRender.then(function (contents) {\n      return this.load(contents);\n    }.bind(this)).then(function () {\n      // find and report the writingMode axis\n      let writingMode = this.contents.writingMode(); // Set the axis based on the flow and writing mode\n\n      let axis;\n\n      if (this.settings.flow === \"scrolled\") {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"horizontal\" : \"vertical\";\n      } else {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"vertical\" : \"horizontal\";\n      }\n\n      if (writingMode.indexOf(\"vertical\") === 0 && this.settings.flow === \"paginated\") {\n        this.layout.delta = this.layout.height;\n      }\n\n      this.setAxis(axis);\n      this.emit(_constants.EVENTS.VIEWS.AXIS, axis);\n      this.setWritingMode(writingMode);\n      this.emit(_constants.EVENTS.VIEWS.WRITING_MODE, writingMode); // apply the layout function to the contents\n\n      this.layout.format(this.contents, this.section, this.axis); // Listen for events that require an expansion of the iframe\n\n      this.addListeners();\n      return new Promise((resolve, reject) => {\n        // Expand the iframe to the full size of the content\n        this.expand();\n\n        if (this.settings.forceRight) {\n          this.element.style.marginLeft = this.width() + \"px\";\n        }\n\n        resolve();\n      });\n    }.bind(this), function (e) {\n      this.emit(_constants.EVENTS.VIEWS.LOAD_ERROR, e);\n      return new Promise((resolve, reject) => {\n        reject(e);\n      });\n    }.bind(this)).then(function () {\n      this.emit(_constants.EVENTS.VIEWS.RENDERED, this.section);\n    }.bind(this));\n  }\n\n  reset() {\n    if (this.iframe) {\n      this.iframe.style.width = \"0\";\n      this.iframe.style.height = \"0\";\n      this._width = 0;\n      this._height = 0;\n      this._textWidth = undefined;\n      this._contentWidth = undefined;\n      this._textHeight = undefined;\n      this._contentHeight = undefined;\n    }\n\n    this._needsReframe = true;\n  } // Determine locks base on settings\n\n\n  size(_width, _height) {\n    var width = _width || this.settings.width;\n    var height = _height || this.settings.height;\n\n    if (this.layout.name === \"pre-paginated\") {\n      this.lock(\"both\", width, height);\n    } else if (this.settings.axis === \"horizontal\") {\n      this.lock(\"height\", width, height);\n    } else {\n      this.lock(\"width\", width, height);\n    }\n\n    this.settings.width = width;\n    this.settings.height = height;\n  } // Lock an axis to element dimensions, taking borders into account\n\n\n  lock(what, width, height) {\n    var elBorders = (0, _core.borders)(this.element);\n    var iframeBorders;\n\n    if (this.iframe) {\n      iframeBorders = (0, _core.borders)(this.iframe);\n    } else {\n      iframeBorders = {\n        width: 0,\n        height: 0\n      };\n    }\n\n    if (what == \"width\" && (0, _core.isNumber)(width)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width; // this.resize(this.lockedWidth, width); //  width keeps ratio correct\n    }\n\n    if (what == \"height\" && (0, _core.isNumber)(height)) {\n      this.lockedHeight = height - elBorders.height - iframeBorders.height; // this.resize(width, this.lockedHeight);\n    }\n\n    if (what === \"both\" && (0, _core.isNumber)(width) && (0, _core.isNumber)(height)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width;\n      this.lockedHeight = height - elBorders.height - iframeBorders.height; // this.resize(this.lockedWidth, this.lockedHeight);\n    }\n\n    if (this.displayed && this.iframe) {\n      // this.contents.layout();\n      this.expand();\n    }\n  } // Resize a single axis based on content dimensions\n\n\n  expand(force) {\n    var width = this.lockedWidth;\n    var height = this.lockedHeight;\n    var columns;\n    var textWidth, textHeight;\n    if (!this.iframe || this._expanding) return;\n    this._expanding = true;\n\n    if (this.layout.name === \"pre-paginated\") {\n      width = this.layout.columnWidth;\n      height = this.layout.height;\n    } // Expand Horizontally\n    else if (this.settings.axis === \"horizontal\") {\n      // Get the width of the text\n      width = this.contents.textWidth();\n\n      if (width % this.layout.pageWidth > 0) {\n        width = Math.ceil(width / this.layout.pageWidth) * this.layout.pageWidth;\n      }\n\n      if (this.settings.forceEvenPages) {\n        columns = width / this.layout.pageWidth;\n\n        if (this.layout.divisor > 1 && this.layout.name === \"reflowable\" && columns % 2 > 0) {\n          // add a blank page\n          width += this.layout.pageWidth;\n        }\n      }\n    } // Expand Vertically\n    else if (this.settings.axis === \"vertical\") {\n      height = this.contents.textHeight();\n\n      if (this.settings.flow === \"paginated\" && height % this.layout.height > 0) {\n        height = Math.ceil(height / this.layout.height) * this.layout.height;\n      }\n    } // Only Resize if dimensions have changed or\n    // if Frame is still hidden, so needs reframing\n\n\n    if (this._needsReframe || width != this._width || height != this._height) {\n      this.reframe(width, height);\n    }\n\n    this._expanding = false;\n  }\n\n  reframe(width, height) {\n    var size;\n\n    if ((0, _core.isNumber)(width)) {\n      this.element.style.width = width + \"px\";\n      this.iframe.style.width = width + \"px\";\n      this._width = width;\n    }\n\n    if ((0, _core.isNumber)(height)) {\n      this.element.style.height = height + \"px\";\n      this.iframe.style.height = height + \"px\";\n      this._height = height;\n    }\n\n    let widthDelta = this.prevBounds ? width - this.prevBounds.width : width;\n    let heightDelta = this.prevBounds ? height - this.prevBounds.height : height;\n    size = {\n      width: width,\n      height: height,\n      widthDelta: widthDelta,\n      heightDelta: heightDelta\n    };\n    this.pane && this.pane.render();\n    requestAnimationFrame(() => {\n      let mark;\n\n      for (let m in this.marks) {\n        if (this.marks.hasOwnProperty(m)) {\n          mark = this.marks[m];\n          this.placeMark(mark.element, mark.range);\n        }\n      }\n    });\n    this.onResize(this, size);\n    this.emit(_constants.EVENTS.VIEWS.RESIZED, size);\n    this.prevBounds = size;\n    this.elementBounds = (0, _core.bounds)(this.element);\n  }\n\n  load(contents) {\n    var loading = new _core.defer();\n    var loaded = loading.promise;\n\n    if (!this.iframe) {\n      loading.reject(new Error(\"No Iframe Available\"));\n      return loaded;\n    }\n\n    this.iframe.onload = function (event) {\n      this.onLoad(event, loading);\n    }.bind(this);\n\n    if (this.settings.method === \"blobUrl\") {\n      this.blobUrl = (0, _core.createBlobUrl)(contents, \"application/xhtml+xml\");\n      this.iframe.src = this.blobUrl;\n      this.element.appendChild(this.iframe);\n    } else if (this.settings.method === \"srcdoc\") {\n      this.iframe.srcdoc = contents;\n      this.element.appendChild(this.iframe);\n    } else {\n      this.element.appendChild(this.iframe);\n      this.document = this.iframe.contentDocument;\n\n      if (!this.document) {\n        loading.reject(new Error(\"No Document Available\"));\n        return loaded;\n      }\n\n      this.iframe.contentDocument.open(); // For Cordova windows platform\n\n      if (window.MSApp && MSApp.execUnsafeLocalFunction) {\n        var outerThis = this;\n        MSApp.execUnsafeLocalFunction(function () {\n          outerThis.iframe.contentDocument.write(contents);\n        });\n      } else {\n        this.iframe.contentDocument.write(contents);\n      }\n\n      this.iframe.contentDocument.close();\n    }\n\n    return loaded;\n  }\n\n  onLoad(event, promise) {\n    this.window = this.iframe.contentWindow;\n    this.document = this.iframe.contentDocument;\n    this.contents = new _contents.default(this.document, this.document.body, this.section.cfiBase, this.section.index);\n    this.rendering = false;\n    var link = this.document.querySelector(\"link[rel='canonical']\");\n\n    if (link) {\n      link.setAttribute(\"href\", this.section.canonical);\n    } else {\n      link = this.document.createElement(\"link\");\n      link.setAttribute(\"rel\", \"canonical\");\n      link.setAttribute(\"href\", this.section.canonical);\n      this.document.querySelector(\"head\").appendChild(link);\n    }\n\n    this.contents.on(_constants.EVENTS.CONTENTS.EXPAND, () => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    this.contents.on(_constants.EVENTS.CONTENTS.RESIZE, e => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    promise.resolve(this.contents);\n  }\n\n  setLayout(layout) {\n    this.layout = layout;\n\n    if (this.contents) {\n      this.layout.format(this.contents);\n      this.expand();\n    }\n  }\n\n  setAxis(axis) {\n    this.settings.axis = axis;\n\n    if (axis == \"horizontal\") {\n      this.element.style.flex = \"none\";\n    } else {\n      this.element.style.flex = \"initial\";\n    }\n\n    this.size();\n  }\n\n  setWritingMode(mode) {\n    // this.element.style.writingMode = writingMode;\n    this.writingMode = mode;\n  }\n\n  addListeners() {//TODO: Add content listeners for expanding\n  }\n\n  removeListeners(layoutFunc) {//TODO: remove content listeners for expanding\n  }\n\n  display(request) {\n    var displayed = new _core.defer();\n\n    if (!this.displayed) {\n      this.render(request).then(function () {\n        this.emit(_constants.EVENTS.VIEWS.DISPLAYED, this);\n        this.onDisplayed(this);\n        this.displayed = true;\n        displayed.resolve(this);\n      }.bind(this), function (err) {\n        displayed.reject(err, this);\n      });\n    } else {\n      displayed.resolve(this);\n    }\n\n    return displayed.promise;\n  }\n\n  show() {\n    this.element.style.visibility = \"visible\";\n\n    if (this.iframe) {\n      this.iframe.style.visibility = \"visible\"; // Remind Safari to redraw the iframe\n\n      this.iframe.style.transform = \"translateZ(0)\";\n      this.iframe.offsetWidth;\n      this.iframe.style.transform = null;\n    }\n\n    this.emit(_constants.EVENTS.VIEWS.SHOWN, this);\n  }\n\n  hide() {\n    // this.iframe.style.display = \"none\";\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.stopExpanding = true;\n    this.emit(_constants.EVENTS.VIEWS.HIDDEN, this);\n  }\n\n  offset() {\n    return {\n      top: this.element.offsetTop,\n      left: this.element.offsetLeft\n    };\n  }\n\n  width() {\n    return this._width;\n  }\n\n  height() {\n    return this._height;\n  }\n\n  position() {\n    return this.element.getBoundingClientRect();\n  }\n\n  locationOf(target) {\n    var parentPos = this.iframe.getBoundingClientRect();\n    var targetPos = this.contents.locationOf(target, this.settings.ignoreClass);\n    return {\n      \"left\": targetPos.left,\n      \"top\": targetPos.top\n    };\n  }\n\n  onDisplayed(view) {// Stub, override with a custom functions\n  }\n\n  onResize(view, e) {// Stub, override with a custom functions\n  }\n\n  bounds(force) {\n    if (force || !this.elementBounds) {\n      this.elementBounds = (0, _core.bounds)(this.element);\n    }\n\n    return this.elementBounds;\n  }\n\n  highlight(cfiRange, data = {}, cb, className = \"epubjs-hl\", styles = {}) {\n    if (!this.contents) {\n      return;\n    }\n\n    const attributes = Object.assign({\n      \"fill\": \"yellow\",\n      \"fill-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n\n    let emitter = () => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    data[\"epubcfi\"] = cfiRange;\n\n    if (!this.pane) {\n      this.pane = new _marksPane.Pane(this.iframe, this.element);\n    }\n\n    let m = new _marksPane.Highlight(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.highlights[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n\n    return h;\n  }\n\n  underline(cfiRange, data = {}, cb, className = \"epubjs-ul\", styles = {}) {\n    if (!this.contents) {\n      return;\n    }\n\n    const attributes = Object.assign({\n      \"stroke\": \"black\",\n      \"stroke-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n\n    let emitter = () => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    data[\"epubcfi\"] = cfiRange;\n\n    if (!this.pane) {\n      this.pane = new _marksPane.Pane(this.iframe, this.element);\n    }\n\n    let m = new _marksPane.Underline(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.underlines[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n\n    return h;\n  }\n\n  mark(cfiRange, data = {}, cb) {\n    if (!this.contents) {\n      return;\n    }\n\n    if (cfiRange in this.marks) {\n      let item = this.marks[cfiRange];\n      return item;\n    }\n\n    let range = this.contents.range(cfiRange);\n\n    if (!range) {\n      return;\n    }\n\n    let container = range.commonAncestorContainer;\n    let parent = container.nodeType === 1 ? container : container.parentNode;\n\n    let emitter = e => {\n      this.emit(_constants.EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n\n    if (range.collapsed && container.nodeType === 1) {\n      range = new Range();\n      range.selectNodeContents(container);\n    } else if (range.collapsed) {\n      // Webkit doesn't like collapsed ranges\n      range = new Range();\n      range.selectNodeContents(parent);\n    }\n\n    let mark = this.document.createElement(\"a\");\n    mark.setAttribute(\"ref\", \"epubjs-mk\");\n    mark.style.position = \"absolute\";\n    mark.dataset[\"epubcfi\"] = cfiRange;\n\n    if (data) {\n      Object.keys(data).forEach(key => {\n        mark.dataset[key] = data[key];\n      });\n    }\n\n    if (cb) {\n      mark.addEventListener(\"click\", cb);\n      mark.addEventListener(\"touchstart\", cb);\n    }\n\n    mark.addEventListener(\"click\", emitter);\n    mark.addEventListener(\"touchstart\", emitter);\n    this.placeMark(mark, range);\n    this.element.appendChild(mark);\n    this.marks[cfiRange] = {\n      \"element\": mark,\n      \"range\": range,\n      \"listeners\": [emitter, cb]\n    };\n    return parent;\n  }\n\n  placeMark(element, range) {\n    let top, right, left;\n\n    if (this.layout.name === \"pre-paginated\" || this.settings.axis !== \"horizontal\") {\n      let pos = range.getBoundingClientRect();\n      top = pos.top;\n      right = pos.right;\n    } else {\n      // Element might break columns, so find the left most element\n      let rects = range.getClientRects();\n      let rect;\n\n      for (var i = 0; i != rects.length; i++) {\n        rect = rects[i];\n\n        if (!left || rect.left < left) {\n          left = rect.left; // right = rect.right;\n\n          right = Math.ceil(left / this.layout.props.pageWidth) * this.layout.props.pageWidth - this.layout.gap / 2;\n          top = rect.top;\n        }\n      }\n    }\n\n    element.style.top = `${top}px`;\n    element.style.left = `${right}px`;\n  }\n\n  unhighlight(cfiRange) {\n    let item;\n\n    if (cfiRange in this.highlights) {\n      item = this.highlights[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.highlights[cfiRange];\n    }\n  }\n\n  ununderline(cfiRange) {\n    let item;\n\n    if (cfiRange in this.underlines) {\n      item = this.underlines[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.underlines[cfiRange];\n    }\n  }\n\n  unmark(cfiRange) {\n    let item;\n\n    if (cfiRange in this.marks) {\n      item = this.marks[cfiRange];\n      this.element.removeChild(item.element);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n\n        ;\n      });\n      delete this.marks[cfiRange];\n    }\n  }\n\n  destroy() {\n    for (let cfiRange in this.highlights) {\n      this.unhighlight(cfiRange);\n    }\n\n    for (let cfiRange in this.underlines) {\n      this.ununderline(cfiRange);\n    }\n\n    for (let cfiRange in this.marks) {\n      this.unmark(cfiRange);\n    }\n\n    if (this.blobUrl) {\n      (0, _core.revokeBlobUrl)(this.blobUrl);\n    }\n\n    if (this.displayed) {\n      this.displayed = false;\n      this.removeListeners();\n      this.contents.destroy();\n      this.stopExpanding = true;\n      this.element.removeChild(this.iframe);\n\n      if (this.pane) {\n        this.pane.element.remove();\n        this.pane = undefined;\n      }\n\n      this.iframe = undefined;\n      this.contents = undefined;\n      this._textWidth = null;\n      this._textHeight = null;\n      this._width = null;\n      this._height = null;\n    } // this.element.style.height = \"0px\";\n    // this.element.style.width = \"0px\";\n\n  }\n\n}\n\n(0, _eventEmitter.default)(IframeView.prototype);\nvar _default = IframeView;\nexports.default = _default;"]},"metadata":{},"sourceType":"script"}