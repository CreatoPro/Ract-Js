{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"./utils/core\");\n\nvar _hook = _interopRequireDefault(require(\"./utils/hook\"));\n\nvar _epubcfi = _interopRequireDefault(require(\"./epubcfi\"));\n\nvar _queue = _interopRequireDefault(require(\"./utils/queue\"));\n\nvar _layout = _interopRequireDefault(require(\"./layout\"));\n\nvar _themes = _interopRequireDefault(require(\"./themes\"));\n\nvar _contents = _interopRequireDefault(require(\"./contents\"));\n\nvar _annotations = _interopRequireDefault(require(\"./annotations\"));\n\nvar _constants = require(\"./utils/constants\");\n\nvar _iframe = _interopRequireDefault(require(\"./managers/views/iframe\"));\n\nvar _index = _interopRequireDefault(require(\"./managers/default/index\"));\n\nvar _index2 = _interopRequireDefault(require(\"./managers/continuous/index\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n} // import Mapping from \"./mapping\";\n// Default Views\n// Default View Managers\n\n/**\n * Displays an Epub as a series of Views for each Section.\n * Requires Manager and View class to handle specifics of rendering\n * the section content.\n * @class\n * @param {Book} book\n * @param {object} [options]\n * @param {number} [options.width]\n * @param {number} [options.height]\n * @param {string} [options.ignoreClass] class for the cfi parser to ignore\n * @param {string | function | object} [options.manager='default']\n * @param {string | function} [options.view='iframe']\n * @param {string} [options.layout] layout to force\n * @param {string} [options.spread] force spread value\n * @param {number} [options.minSpreadWidth] overridden by spread: none (never) / both (always)\n * @param {string} [options.stylesheet] url of stylesheet to be injected\n * @param {boolean} [options.resizeOnOrientationChange] false to disable orientation events\n * @param {string} [options.script] url of script to be injected\n * @param {boolean | object} [options.snap=false] use snap scrolling\n * @param {string} [options.defaultDirection='ltr'] default text direction\n * @param {boolean} [options.allowScriptedContent=false] enable running scripts in content\n * @param {boolean} [options.allowPopups=false] enable opening popup in content\n */\n\n\nclass Rendition {\n  constructor(book, options) {\n    this.settings = (0, _core.extend)(this.settings || {}, {\n      width: null,\n      height: null,\n      ignoreClass: \"\",\n      manager: \"default\",\n      view: \"iframe\",\n      flow: null,\n      layout: null,\n      spread: null,\n      minSpreadWidth: 800,\n      stylesheet: null,\n      resizeOnOrientationChange: true,\n      script: null,\n      snap: false,\n      defaultDirection: \"ltr\",\n      allowScriptedContent: false,\n      allowPopups: false\n    });\n    (0, _core.extend)(this.settings, options);\n\n    if (typeof this.settings.manager === \"object\") {\n      this.manager = this.settings.manager;\n    }\n\n    this.book = book;\n    /**\n     * Adds Hook methods to the Rendition prototype\n     * @member {object} hooks\n     * @property {Hook} hooks.content\n     * @memberof Rendition\n     */\n\n    this.hooks = {};\n    this.hooks.display = new _hook.default(this);\n    this.hooks.serialize = new _hook.default(this);\n    this.hooks.content = new _hook.default(this);\n    this.hooks.unloaded = new _hook.default(this);\n    this.hooks.layout = new _hook.default(this);\n    this.hooks.render = new _hook.default(this);\n    this.hooks.show = new _hook.default(this);\n    this.hooks.content.register(this.handleLinks.bind(this));\n    this.hooks.content.register(this.passEvents.bind(this));\n    this.hooks.content.register(this.adjustImages.bind(this));\n    this.book.spine.hooks.content.register(this.injectIdentifier.bind(this));\n\n    if (this.settings.stylesheet) {\n      this.book.spine.hooks.content.register(this.injectStylesheet.bind(this));\n    }\n\n    if (this.settings.script) {\n      this.book.spine.hooks.content.register(this.injectScript.bind(this));\n    }\n    /**\n     * @member {Themes} themes\n     * @memberof Rendition\n     */\n\n\n    this.themes = new _themes.default(this);\n    /**\n     * @member {Annotations} annotations\n     * @memberof Rendition\n     */\n\n    this.annotations = new _annotations.default(this);\n    this.epubcfi = new _epubcfi.default();\n    this.q = new _queue.default(this);\n    /**\n     * A Rendered Location Range\n     * @typedef location\n     * @type {Object}\n     * @property {object} start\n     * @property {string} start.index\n     * @property {string} start.href\n     * @property {object} start.displayed\n     * @property {EpubCFI} start.cfi\n     * @property {number} start.location\n     * @property {number} start.percentage\n     * @property {number} start.displayed.page\n     * @property {number} start.displayed.total\n     * @property {object} end\n     * @property {string} end.index\n     * @property {string} end.href\n     * @property {object} end.displayed\n     * @property {EpubCFI} end.cfi\n     * @property {number} end.location\n     * @property {number} end.percentage\n     * @property {number} end.displayed.page\n     * @property {number} end.displayed.total\n     * @property {boolean} atStart\n     * @property {boolean} atEnd\n     * @memberof Rendition\n     */\n\n    this.location = undefined; // Hold queue until book is opened\n\n    this.q.enqueue(this.book.opened);\n    this.starting = new _core.defer();\n    /**\n     * @member {promise} started returns after the rendition has started\n     * @memberof Rendition\n     */\n\n    this.started = this.starting.promise; // Block the queue until rendering is started\n\n    this.q.enqueue(this.start);\n  }\n  /**\n   * Set the manager function\n   * @param {function} manager\n   */\n\n\n  setManager(manager) {\n    this.manager = manager;\n  }\n  /**\n   * Require the manager from passed string, or as a class function\n   * @param  {string|object} manager [description]\n   * @return {method}\n   */\n\n\n  requireManager(manager) {\n    var viewManager; // If manager is a string, try to load from imported managers\n\n    if (typeof manager === \"string\" && manager === \"default\") {\n      viewManager = _index.default;\n    } else if (typeof manager === \"string\" && manager === \"continuous\") {\n      viewManager = _index2.default;\n    } else {\n      // otherwise, assume we were passed a class function\n      viewManager = manager;\n    }\n\n    return viewManager;\n  }\n  /**\n   * Require the view from passed string, or as a class function\n   * @param  {string|object} view\n   * @return {view}\n   */\n\n\n  requireView(view) {\n    var View; // If view is a string, try to load from imported views,\n\n    if (typeof view == \"string\" && view === \"iframe\") {\n      View = _iframe.default;\n    } else {\n      // otherwise, assume we were passed a class function\n      View = view;\n    }\n\n    return View;\n  }\n  /**\n   * Start the rendering\n   * @return {Promise} rendering has started\n   */\n\n\n  start() {\n    if (!this.settings.layout && (this.book.package.metadata.layout === \"pre-paginated\" || this.book.displayOptions.fixedLayout === \"true\")) {\n      this.settings.layout = \"pre-paginated\";\n    }\n\n    switch (this.book.package.metadata.spread) {\n      case 'none':\n        this.settings.spread = 'none';\n        break;\n\n      case 'both':\n        this.settings.spread = true;\n        break;\n    }\n\n    if (!this.manager) {\n      this.ViewManager = this.requireManager(this.settings.manager);\n      this.View = this.requireView(this.settings.view);\n      this.manager = new this.ViewManager({\n        view: this.View,\n        queue: this.q,\n        request: this.book.load.bind(this.book),\n        settings: this.settings\n      });\n    }\n\n    this.direction(this.book.package.metadata.direction || this.settings.defaultDirection); // Parse metadata to get layout props\n\n    this.settings.globalLayoutProperties = this.determineLayoutProperties(this.book.package.metadata);\n    this.flow(this.settings.globalLayoutProperties.flow);\n    this.layout(this.settings.globalLayoutProperties); // Listen for displayed views\n\n    this.manager.on(_constants.EVENTS.MANAGERS.ADDED, this.afterDisplayed.bind(this));\n    this.manager.on(_constants.EVENTS.MANAGERS.REMOVED, this.afterRemoved.bind(this)); // Listen for resizing\n\n    this.manager.on(_constants.EVENTS.MANAGERS.RESIZED, this.onResized.bind(this)); // Listen for rotation\n\n    this.manager.on(_constants.EVENTS.MANAGERS.ORIENTATION_CHANGE, this.onOrientationChange.bind(this)); // Listen for scroll changes\n\n    this.manager.on(_constants.EVENTS.MANAGERS.SCROLLED, this.reportLocation.bind(this));\n    /**\n     * Emit that rendering has started\n     * @event started\n     * @memberof Rendition\n     */\n\n    this.emit(_constants.EVENTS.RENDITION.STARTED); // Start processing queue\n\n    this.starting.resolve();\n  }\n  /**\n   * Call to attach the container to an element in the dom\n   * Container must be attached before rendering can begin\n   * @param  {element} element to attach to\n   * @return {Promise}\n   */\n\n\n  attachTo(element) {\n    return this.q.enqueue(function () {\n      // Start rendering\n      this.manager.render(element, {\n        \"width\": this.settings.width,\n        \"height\": this.settings.height\n      });\n      /**\n       * Emit that rendering has attached to an element\n       * @event attached\n       * @memberof Rendition\n       */\n\n      this.emit(_constants.EVENTS.RENDITION.ATTACHED);\n    }.bind(this));\n  }\n  /**\n   * Display a point in the book\n   * The request will be added to the rendering Queue,\n   * so it will wait until book is opened, rendering started\n   * and all other rendering tasks have finished to be called.\n   * @param  {string} target Url or EpubCFI\n   * @return {Promise}\n   */\n\n\n  display(target) {\n    if (this.displaying) {\n      this.displaying.resolve();\n    }\n\n    return this.q.enqueue(this._display, target);\n  }\n  /**\n   * Tells the manager what to display immediately\n   * @private\n   * @param  {string} target Url or EpubCFI\n   * @return {Promise}\n   */\n\n\n  _display(target) {\n    if (!this.book) {\n      return;\n    }\n\n    var isCfiString = this.epubcfi.isCfiString(target);\n    var displaying = new _core.defer();\n    var displayed = displaying.promise;\n    var section;\n    var moveTo;\n    this.displaying = displaying; // Check if this is a book percentage\n\n    if (this.book.locations.length() && (0, _core.isFloat)(target)) {\n      target = this.book.locations.cfiFromPercentage(parseFloat(target));\n    }\n\n    section = this.book.spine.get(target);\n\n    if (!section) {\n      displaying.reject(new Error(\"No Section Found\"));\n      return displayed;\n    }\n\n    this.manager.display(section, target).then(() => {\n      displaying.resolve(section);\n      this.displaying = undefined;\n      /**\n       * Emit that a section has been displayed\n       * @event displayed\n       * @param {Section} section\n       * @memberof Rendition\n       */\n\n      this.emit(_constants.EVENTS.RENDITION.DISPLAYED, section);\n      this.reportLocation();\n    }, err => {\n      /**\n       * Emit that has been an error displaying\n       * @event displayError\n       * @param {Section} section\n       * @memberof Rendition\n       */\n      this.emit(_constants.EVENTS.RENDITION.DISPLAY_ERROR, err);\n    });\n    return displayed;\n  }\n  /*\n  render(view, show) {\n  \t\t// view.onLayout = this.layout.format.bind(this.layout);\n  \tview.create();\n  \t\t// Fit to size of the container, apply padding\n  \tthis.manager.resizeView(view);\n  \t\t// Render Chain\n  \treturn view.section.render(this.book.request)\n  \t\t.then(function(contents){\n  \t\t\treturn view.load(contents);\n  \t\t}.bind(this))\n  \t\t.then(function(doc){\n  \t\t\treturn this.hooks.content.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\tthis.layout.format(view.contents);\n  \t\t\treturn this.hooks.layout.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\treturn view.display();\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\treturn this.hooks.render.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\tif(show !== false) {\n  \t\t\t\tthis.q.enqueue(function(view){\n  \t\t\t\t\tview.show();\n  \t\t\t\t}, view);\n  \t\t\t}\n  \t\t\t// this.map = new Map(view, this.layout);\n  \t\t\tthis.hooks.show.trigger(view, this);\n  \t\t\tthis.trigger(\"rendered\", view.section);\n  \t\t\t}.bind(this))\n  \t\t.catch(function(e){\n  \t\t\tthis.trigger(\"loaderror\", e);\n  \t\t}.bind(this));\n  \t}\n  */\n\n  /**\n   * Report what section has been displayed\n   * @private\n   * @param  {*} view\n   */\n\n\n  afterDisplayed(view) {\n    view.on(_constants.EVENTS.VIEWS.MARK_CLICKED, (cfiRange, data) => this.triggerMarkEvent(cfiRange, data, view.contents));\n    this.hooks.render.trigger(view, this).then(() => {\n      if (view.contents) {\n        this.hooks.content.trigger(view.contents, this).then(() => {\n          /**\n           * Emit that a section has been rendered\n           * @event rendered\n           * @param {Section} section\n           * @param {View} view\n           * @memberof Rendition\n           */\n          this.emit(_constants.EVENTS.RENDITION.RENDERED, view.section, view);\n        });\n      } else {\n        this.emit(_constants.EVENTS.RENDITION.RENDERED, view.section, view);\n      }\n    });\n  }\n  /**\n   * Report what has been removed\n   * @private\n   * @param  {*} view\n   */\n\n\n  afterRemoved(view) {\n    this.hooks.unloaded.trigger(view, this).then(() => {\n      /**\n       * Emit that a section has been removed\n       * @event removed\n       * @param {Section} section\n       * @param {View} view\n       * @memberof Rendition\n       */\n      this.emit(_constants.EVENTS.RENDITION.REMOVED, view.section, view);\n    });\n  }\n  /**\n   * Report resize events and display the last seen location\n   * @private\n   */\n\n\n  onResized(size, epubcfi) {\n    /**\n     * Emit that the rendition has been resized\n     * @event resized\n     * @param {number} width\n     * @param {height} height\n     * @param {string} epubcfi (optional)\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.RESIZED, {\n      width: size.width,\n      height: size.height\n    }, epubcfi);\n\n    if (this.location && this.location.start) {\n      this.display(epubcfi || this.location.start.cfi);\n    }\n  }\n  /**\n   * Report orientation events and display the last seen location\n   * @private\n   */\n\n\n  onOrientationChange(orientation) {\n    /**\n     * Emit that the rendition has been rotated\n     * @event orientationchange\n     * @param {string} orientation\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.ORIENTATION_CHANGE, orientation);\n  }\n  /**\n   * Move the Rendition to a specific offset\n   * Usually you would be better off calling display()\n   * @param {object} offset\n   */\n\n\n  moveTo(offset) {\n    this.manager.moveTo(offset);\n  }\n  /**\n   * Trigger a resize of the views\n   * @param {number} [width]\n   * @param {number} [height]\n   * @param {string} [epubcfi] (optional)\n   */\n\n\n  resize(width, height, epubcfi) {\n    if (width) {\n      this.settings.width = width;\n    }\n\n    if (height) {\n      this.settings.height = height;\n    }\n\n    this.manager.resize(width, height, epubcfi);\n  }\n  /**\n   * Clear all rendered views\n   */\n\n\n  clear() {\n    this.manager.clear();\n  }\n  /**\n   * Go to the next \"page\" in the rendition\n   * @return {Promise}\n   */\n\n\n  next() {\n    return this.q.enqueue(this.manager.next.bind(this.manager)).then(this.reportLocation.bind(this));\n  }\n  /**\n   * Go to the previous \"page\" in the rendition\n   * @return {Promise}\n   */\n\n\n  prev() {\n    return this.q.enqueue(this.manager.prev.bind(this.manager)).then(this.reportLocation.bind(this));\n  } //-- http://www.idpf.org/epub/301/spec/epub-publications.html#meta-properties-rendering\n\n  /**\n   * Determine the Layout properties from metadata and settings\n   * @private\n   * @param  {object} metadata\n   * @return {object} properties\n   */\n\n\n  determineLayoutProperties(metadata) {\n    var properties;\n    var layout = this.settings.layout || metadata.layout || \"reflowable\";\n    var spread = this.settings.spread || metadata.spread || \"auto\";\n    var orientation = this.settings.orientation || metadata.orientation || \"auto\";\n    var flow = this.settings.flow || metadata.flow || \"auto\";\n    var viewport = metadata.viewport || \"\";\n    var minSpreadWidth = this.settings.minSpreadWidth || metadata.minSpreadWidth || 800;\n    var direction = this.settings.direction || metadata.direction || \"ltr\";\n\n    if ((this.settings.width === 0 || this.settings.width > 0) && (this.settings.height === 0 || this.settings.height > 0)) {// viewport = \"width=\"+this.settings.width+\", height=\"+this.settings.height+\"\";\n    }\n\n    properties = {\n      layout: layout,\n      spread: spread,\n      orientation: orientation,\n      flow: flow,\n      viewport: viewport,\n      minSpreadWidth: minSpreadWidth,\n      direction: direction\n    };\n    return properties;\n  }\n  /**\n   * Adjust the flow of the rendition to paginated or scrolled\n   * (scrolled-continuous vs scrolled-doc are handled by different view managers)\n   * @param  {string} flow\n   */\n\n\n  flow(flow) {\n    var _flow = flow;\n\n    if (flow === \"scrolled\" || flow === \"scrolled-doc\" || flow === \"scrolled-continuous\") {\n      _flow = \"scrolled\";\n    }\n\n    if (flow === \"auto\" || flow === \"paginated\") {\n      _flow = \"paginated\";\n    }\n\n    this.settings.flow = flow;\n\n    if (this._layout) {\n      this._layout.flow(_flow);\n    }\n\n    if (this.manager && this._layout) {\n      this.manager.applyLayout(this._layout);\n    }\n\n    if (this.manager) {\n      this.manager.updateFlow(_flow);\n    }\n\n    if (this.manager && this.manager.isRendered() && this.location) {\n      this.manager.clear();\n      this.display(this.location.start.cfi);\n    }\n  }\n  /**\n   * Adjust the layout of the rendition to reflowable or pre-paginated\n   * @param  {object} settings\n   */\n\n\n  layout(settings) {\n    if (settings) {\n      this._layout = new _layout.default(settings);\n\n      this._layout.spread(settings.spread, this.settings.minSpreadWidth); // this.mapping = new Mapping(this._layout.props);\n\n\n      this._layout.on(_constants.EVENTS.LAYOUT.UPDATED, (props, changed) => {\n        this.emit(_constants.EVENTS.RENDITION.LAYOUT, props, changed);\n      });\n    }\n\n    if (this.manager && this._layout) {\n      this.manager.applyLayout(this._layout);\n    }\n\n    return this._layout;\n  }\n  /**\n   * Adjust if the rendition uses spreads\n   * @param  {string} spread none | auto (TODO: implement landscape, portrait, both)\n   * @param  {int} [min] min width to use spreads at\n   */\n\n\n  spread(spread, min) {\n    this.settings.spread = spread;\n\n    if (min) {\n      this.settings.minSpreadWidth = min;\n    }\n\n    if (this._layout) {\n      this._layout.spread(spread, min);\n    }\n\n    if (this.manager && this.manager.isRendered()) {\n      this.manager.updateLayout();\n    }\n  }\n  /**\n   * Adjust the direction of the rendition\n   * @param  {string} dir\n   */\n\n\n  direction(dir) {\n    this.settings.direction = dir || \"ltr\";\n\n    if (this.manager) {\n      this.manager.direction(this.settings.direction);\n    }\n\n    if (this.manager && this.manager.isRendered() && this.location) {\n      this.manager.clear();\n      this.display(this.location.start.cfi);\n    }\n  }\n  /**\n   * Report the current location\n   * @fires relocated\n   * @fires locationChanged\n   */\n\n\n  reportLocation() {\n    return this.q.enqueue(function reportedLocation() {\n      requestAnimationFrame(function reportedLocationAfterRAF() {\n        var location = this.manager.currentLocation();\n\n        if (location && location.then && typeof location.then === \"function\") {\n          location.then(function (result) {\n            let located = this.located(result);\n\n            if (!located || !located.start || !located.end) {\n              return;\n            }\n\n            this.location = located;\n            this.emit(_constants.EVENTS.RENDITION.LOCATION_CHANGED, {\n              index: this.location.start.index,\n              href: this.location.start.href,\n              start: this.location.start.cfi,\n              end: this.location.end.cfi,\n              percentage: this.location.start.percentage\n            });\n            this.emit(_constants.EVENTS.RENDITION.RELOCATED, this.location);\n          }.bind(this));\n        } else if (location) {\n          let located = this.located(location);\n\n          if (!located || !located.start || !located.end) {\n            return;\n          }\n\n          this.location = located;\n          /**\n           * @event locationChanged\n           * @deprecated\n           * @type {object}\n           * @property {number} index\n           * @property {string} href\n           * @property {EpubCFI} start\n           * @property {EpubCFI} end\n           * @property {number} percentage\n           * @memberof Rendition\n           */\n\n          this.emit(_constants.EVENTS.RENDITION.LOCATION_CHANGED, {\n            index: this.location.start.index,\n            href: this.location.start.href,\n            start: this.location.start.cfi,\n            end: this.location.end.cfi,\n            percentage: this.location.start.percentage\n          });\n          /**\n           * @event relocated\n           * @type {displayedLocation}\n           * @memberof Rendition\n           */\n\n          this.emit(_constants.EVENTS.RENDITION.RELOCATED, this.location);\n        }\n      }.bind(this));\n    }.bind(this));\n  }\n  /**\n   * Get the Current Location object\n   * @return {displayedLocation | promise} location (may be a promise)\n   */\n\n\n  currentLocation() {\n    var location = this.manager.currentLocation();\n\n    if (location && location.then && typeof location.then === \"function\") {\n      location.then(function (result) {\n        let located = this.located(result);\n        return located;\n      }.bind(this));\n    } else if (location) {\n      let located = this.located(location);\n      return located;\n    }\n  }\n  /**\n   * Creates a Rendition#locationRange from location\n   * passed by the Manager\n   * @returns {displayedLocation}\n   * @private\n   */\n\n\n  located(location) {\n    if (!location.length) {\n      return {};\n    }\n\n    let start = location[0];\n    let end = location[location.length - 1];\n    let located = {\n      start: {\n        index: start.index,\n        href: start.href,\n        cfi: start.mapping.start,\n        displayed: {\n          page: start.pages[0] || 1,\n          total: start.totalPages\n        }\n      },\n      end: {\n        index: end.index,\n        href: end.href,\n        cfi: end.mapping.end,\n        displayed: {\n          page: end.pages[end.pages.length - 1] || 1,\n          total: end.totalPages\n        }\n      }\n    };\n    let locationStart = this.book.locations.locationFromCfi(start.mapping.start);\n    let locationEnd = this.book.locations.locationFromCfi(end.mapping.end);\n\n    if (locationStart != null) {\n      located.start.location = locationStart;\n      located.start.percentage = this.book.locations.percentageFromLocation(locationStart);\n    }\n\n    if (locationEnd != null) {\n      located.end.location = locationEnd;\n      located.end.percentage = this.book.locations.percentageFromLocation(locationEnd);\n    }\n\n    let pageStart = this.book.pageList.pageFromCfi(start.mapping.start);\n    let pageEnd = this.book.pageList.pageFromCfi(end.mapping.end);\n\n    if (pageStart != -1) {\n      located.start.page = pageStart;\n    }\n\n    if (pageEnd != -1) {\n      located.end.page = pageEnd;\n    }\n\n    if (end.index === this.book.spine.last().index && located.end.displayed.page >= located.end.displayed.total) {\n      located.atEnd = true;\n    }\n\n    if (start.index === this.book.spine.first().index && located.start.displayed.page === 1) {\n      located.atStart = true;\n    }\n\n    return located;\n  }\n  /**\n   * Remove and Clean Up the Rendition\n   */\n\n\n  destroy() {\n    // Clear the queue\n    // this.q.clear();\n    // this.q = undefined;\n    this.manager && this.manager.destroy();\n    this.book = undefined; // this.views = null;\n    // this.hooks.display.clear();\n    // this.hooks.serialize.clear();\n    // this.hooks.content.clear();\n    // this.hooks.layout.clear();\n    // this.hooks.render.clear();\n    // this.hooks.show.clear();\n    // this.hooks = {};\n    // this.themes.destroy();\n    // this.themes = undefined;\n    // this.epubcfi = undefined;\n    // this.starting = undefined;\n    // this.started = undefined;\n  }\n  /**\n   * Pass the events from a view's Contents\n   * @private\n   * @param  {Contents} view contents\n   */\n\n\n  passEvents(contents) {\n    _constants.DOM_EVENTS.forEach(e => {\n      contents.on(e, ev => this.triggerViewEvent(ev, contents));\n    });\n\n    contents.on(_constants.EVENTS.CONTENTS.SELECTED, e => this.triggerSelectedEvent(e, contents));\n  }\n  /**\n   * Emit events passed by a view\n   * @private\n   * @param  {event} e\n   */\n\n\n  triggerViewEvent(e, contents) {\n    this.emit(e.type, e, contents);\n  }\n  /**\n   * Emit a selection event's CFI Range passed from a a view\n   * @private\n   * @param  {string} cfirange\n   */\n\n\n  triggerSelectedEvent(cfirange, contents) {\n    /**\n     * Emit that a text selection has occurred\n     * @event selected\n     * @param {string} cfirange\n     * @param {Contents} contents\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.SELECTED, cfirange, contents);\n  }\n  /**\n   * Emit a markClicked event with the cfiRange and data from a mark\n   * @private\n   * @param  {EpubCFI} cfirange\n   */\n\n\n  triggerMarkEvent(cfiRange, data, contents) {\n    /**\n     * Emit that a mark was clicked\n     * @event markClicked\n     * @param {EpubCFI} cfirange\n     * @param {object} data\n     * @param {Contents} contents\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.MARK_CLICKED, cfiRange, data, contents);\n  }\n  /**\n   * Get a Range from a Visible CFI\n   * @param  {string} cfi EpubCfi String\n   * @param  {string} ignoreClass\n   * @return {range}\n   */\n\n\n  getRange(cfi, ignoreClass) {\n    var _cfi = new _epubcfi.default(cfi);\n\n    var found = this.manager.visible().filter(function (view) {\n      if (_cfi.spinePos === view.index) return true;\n    }); // Should only every return 1 item\n\n    if (found.length) {\n      return found[0].contents.range(_cfi, ignoreClass);\n    }\n  }\n  /**\n   * Hook to adjust images to fit in columns\n   * @param  {Contents} contents\n   * @private\n   */\n\n\n  adjustImages(contents) {\n    if (this._layout.name === \"pre-paginated\") {\n      return new Promise(function (resolve) {\n        resolve();\n      });\n    }\n\n    let computed = contents.window.getComputedStyle(contents.content, null);\n    let height = (contents.content.offsetHeight - (parseFloat(computed.paddingTop) + parseFloat(computed.paddingBottom))) * .95;\n    let horizontalPadding = parseFloat(computed.paddingLeft) + parseFloat(computed.paddingRight);\n    contents.addStylesheetRules({\n      \"img\": {\n        \"max-width\": (this._layout.columnWidth ? this._layout.columnWidth - horizontalPadding + \"px\" : \"100%\") + \"!important\",\n        \"max-height\": height + \"px\" + \"!important\",\n        \"object-fit\": \"contain\",\n        \"page-break-inside\": \"avoid\",\n        \"break-inside\": \"avoid\",\n        \"box-sizing\": \"border-box\"\n      },\n      \"svg\": {\n        \"max-width\": (this._layout.columnWidth ? this._layout.columnWidth - horizontalPadding + \"px\" : \"100%\") + \"!important\",\n        \"max-height\": height + \"px\" + \"!important\",\n        \"page-break-inside\": \"avoid\",\n        \"break-inside\": \"avoid\"\n      }\n    });\n    return new Promise(function (resolve, reject) {\n      // Wait to apply\n      setTimeout(function () {\n        resolve();\n      }, 1);\n    });\n  }\n  /**\n   * Get the Contents object of each rendered view\n   * @returns {Contents[]}\n   */\n\n\n  getContents() {\n    return this.manager ? this.manager.getContents() : [];\n  }\n  /**\n   * Get the views member from the manager\n   * @returns {Views}\n   */\n\n\n  views() {\n    let views = this.manager ? this.manager.views : undefined;\n    return views || [];\n  }\n  /**\n   * Hook to handle link clicks in rendered content\n   * @param  {Contents} contents\n   * @private\n   */\n\n\n  handleLinks(contents) {\n    if (contents) {\n      contents.on(_constants.EVENTS.CONTENTS.LINK_CLICKED, href => {\n        let relative = this.book.path.relative(href);\n        this.display(relative);\n      });\n    }\n  }\n  /**\n   * Hook to handle injecting stylesheet before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectStylesheet(doc, section) {\n    let style = doc.createElement(\"link\");\n    style.setAttribute(\"type\", \"text/css\");\n    style.setAttribute(\"rel\", \"stylesheet\");\n    style.setAttribute(\"href\", this.settings.stylesheet);\n    doc.getElementsByTagName(\"head\")[0].appendChild(style);\n  }\n  /**\n   * Hook to handle injecting scripts before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectScript(doc, section) {\n    let script = doc.createElement(\"script\");\n    script.setAttribute(\"type\", \"text/javascript\");\n    script.setAttribute(\"src\", this.settings.script);\n    script.textContent = \" \"; // Needed to prevent self closing tag\n\n    doc.getElementsByTagName(\"head\")[0].appendChild(script);\n  }\n  /**\n   * Hook to handle the document identifier before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectIdentifier(doc, section) {\n    let ident = this.book.packaging.metadata.identifier;\n    let meta = doc.createElement(\"meta\");\n    meta.setAttribute(\"name\", \"dc.relation.ispartof\");\n\n    if (ident) {\n      meta.setAttribute(\"content\", ident);\n    }\n\n    doc.getElementsByTagName(\"head\")[0].appendChild(meta);\n  }\n\n} //-- Enable binding events to Renderer\n\n\n(0, _eventEmitter.default)(Rendition.prototype);\nvar _default = Rendition;\nexports.default = _default;","map":{"version":3,"sources":["S:/REACT/Ract-Js/Frlnce/node_modules/epubjs/lib/rendition.js"],"names":["Object","defineProperty","exports","value","default","_eventEmitter","_interopRequireDefault","require","_core","_hook","_epubcfi","_queue","_layout","_themes","_contents","_annotations","_constants","_iframe","_index","_index2","obj","__esModule","Rendition","constructor","book","options","settings","extend","width","height","ignoreClass","manager","view","flow","layout","spread","minSpreadWidth","stylesheet","resizeOnOrientationChange","script","snap","defaultDirection","allowScriptedContent","allowPopups","hooks","display","serialize","content","unloaded","render","show","register","handleLinks","bind","passEvents","adjustImages","spine","injectIdentifier","injectStylesheet","injectScript","themes","annotations","epubcfi","q","location","undefined","enqueue","opened","starting","defer","started","promise","start","setManager","requireManager","viewManager","requireView","View","package","metadata","displayOptions","fixedLayout","ViewManager","queue","request","load","direction","globalLayoutProperties","determineLayoutProperties","on","EVENTS","MANAGERS","ADDED","afterDisplayed","REMOVED","afterRemoved","RESIZED","onResized","ORIENTATION_CHANGE","onOrientationChange","SCROLLED","reportLocation","emit","RENDITION","STARTED","resolve","attachTo","element","ATTACHED","target","displaying","_display","isCfiString","displayed","section","moveTo","locations","length","isFloat","cfiFromPercentage","parseFloat","get","reject","Error","then","DISPLAYED","err","DISPLAY_ERROR","VIEWS","MARK_CLICKED","cfiRange","data","triggerMarkEvent","contents","trigger","RENDERED","size","cfi","orientation","offset","resize","clear","next","prev","properties","viewport","_flow","applyLayout","updateFlow","isRendered","LAYOUT","UPDATED","props","changed","min","updateLayout","dir","reportedLocation","requestAnimationFrame","reportedLocationAfterRAF","currentLocation","result","located","end","LOCATION_CHANGED","index","href","percentage","RELOCATED","mapping","page","pages","total","totalPages","locationStart","locationFromCfi","locationEnd","percentageFromLocation","pageStart","pageList","pageFromCfi","pageEnd","last","atEnd","first","atStart","destroy","DOM_EVENTS","forEach","e","ev","triggerViewEvent","CONTENTS","SELECTED","triggerSelectedEvent","type","cfirange","getRange","_cfi","found","visible","filter","spinePos","range","name","Promise","computed","window","getComputedStyle","offsetHeight","paddingTop","paddingBottom","horizontalPadding","paddingLeft","paddingRight","addStylesheetRules","columnWidth","setTimeout","getContents","views","LINK_CLICKED","relative","path","doc","style","createElement","setAttribute","getElementsByTagName","appendChild","textContent","ident","packaging","identifier","meta","prototype","_default"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"./utils/core\");\n\nvar _hook = _interopRequireDefault(require(\"./utils/hook\"));\n\nvar _epubcfi = _interopRequireDefault(require(\"./epubcfi\"));\n\nvar _queue = _interopRequireDefault(require(\"./utils/queue\"));\n\nvar _layout = _interopRequireDefault(require(\"./layout\"));\n\nvar _themes = _interopRequireDefault(require(\"./themes\"));\n\nvar _contents = _interopRequireDefault(require(\"./contents\"));\n\nvar _annotations = _interopRequireDefault(require(\"./annotations\"));\n\nvar _constants = require(\"./utils/constants\");\n\nvar _iframe = _interopRequireDefault(require(\"./managers/views/iframe\"));\n\nvar _index = _interopRequireDefault(require(\"./managers/default/index\"));\n\nvar _index2 = _interopRequireDefault(require(\"./managers/continuous/index\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// import Mapping from \"./mapping\";\n// Default Views\n// Default View Managers\n\n/**\n * Displays an Epub as a series of Views for each Section.\n * Requires Manager and View class to handle specifics of rendering\n * the section content.\n * @class\n * @param {Book} book\n * @param {object} [options]\n * @param {number} [options.width]\n * @param {number} [options.height]\n * @param {string} [options.ignoreClass] class for the cfi parser to ignore\n * @param {string | function | object} [options.manager='default']\n * @param {string | function} [options.view='iframe']\n * @param {string} [options.layout] layout to force\n * @param {string} [options.spread] force spread value\n * @param {number} [options.minSpreadWidth] overridden by spread: none (never) / both (always)\n * @param {string} [options.stylesheet] url of stylesheet to be injected\n * @param {boolean} [options.resizeOnOrientationChange] false to disable orientation events\n * @param {string} [options.script] url of script to be injected\n * @param {boolean | object} [options.snap=false] use snap scrolling\n * @param {string} [options.defaultDirection='ltr'] default text direction\n * @param {boolean} [options.allowScriptedContent=false] enable running scripts in content\n * @param {boolean} [options.allowPopups=false] enable opening popup in content\n */\nclass Rendition {\n  constructor(book, options) {\n    this.settings = (0, _core.extend)(this.settings || {}, {\n      width: null,\n      height: null,\n      ignoreClass: \"\",\n      manager: \"default\",\n      view: \"iframe\",\n      flow: null,\n      layout: null,\n      spread: null,\n      minSpreadWidth: 800,\n      stylesheet: null,\n      resizeOnOrientationChange: true,\n      script: null,\n      snap: false,\n      defaultDirection: \"ltr\",\n      allowScriptedContent: false,\n      allowPopups: false\n    });\n    (0, _core.extend)(this.settings, options);\n\n    if (typeof this.settings.manager === \"object\") {\n      this.manager = this.settings.manager;\n    }\n\n    this.book = book;\n    /**\n     * Adds Hook methods to the Rendition prototype\n     * @member {object} hooks\n     * @property {Hook} hooks.content\n     * @memberof Rendition\n     */\n\n    this.hooks = {};\n    this.hooks.display = new _hook.default(this);\n    this.hooks.serialize = new _hook.default(this);\n    this.hooks.content = new _hook.default(this);\n    this.hooks.unloaded = new _hook.default(this);\n    this.hooks.layout = new _hook.default(this);\n    this.hooks.render = new _hook.default(this);\n    this.hooks.show = new _hook.default(this);\n    this.hooks.content.register(this.handleLinks.bind(this));\n    this.hooks.content.register(this.passEvents.bind(this));\n    this.hooks.content.register(this.adjustImages.bind(this));\n    this.book.spine.hooks.content.register(this.injectIdentifier.bind(this));\n\n    if (this.settings.stylesheet) {\n      this.book.spine.hooks.content.register(this.injectStylesheet.bind(this));\n    }\n\n    if (this.settings.script) {\n      this.book.spine.hooks.content.register(this.injectScript.bind(this));\n    }\n    /**\n     * @member {Themes} themes\n     * @memberof Rendition\n     */\n\n\n    this.themes = new _themes.default(this);\n    /**\n     * @member {Annotations} annotations\n     * @memberof Rendition\n     */\n\n    this.annotations = new _annotations.default(this);\n    this.epubcfi = new _epubcfi.default();\n    this.q = new _queue.default(this);\n    /**\n     * A Rendered Location Range\n     * @typedef location\n     * @type {Object}\n     * @property {object} start\n     * @property {string} start.index\n     * @property {string} start.href\n     * @property {object} start.displayed\n     * @property {EpubCFI} start.cfi\n     * @property {number} start.location\n     * @property {number} start.percentage\n     * @property {number} start.displayed.page\n     * @property {number} start.displayed.total\n     * @property {object} end\n     * @property {string} end.index\n     * @property {string} end.href\n     * @property {object} end.displayed\n     * @property {EpubCFI} end.cfi\n     * @property {number} end.location\n     * @property {number} end.percentage\n     * @property {number} end.displayed.page\n     * @property {number} end.displayed.total\n     * @property {boolean} atStart\n     * @property {boolean} atEnd\n     * @memberof Rendition\n     */\n\n    this.location = undefined; // Hold queue until book is opened\n\n    this.q.enqueue(this.book.opened);\n    this.starting = new _core.defer();\n    /**\n     * @member {promise} started returns after the rendition has started\n     * @memberof Rendition\n     */\n\n    this.started = this.starting.promise; // Block the queue until rendering is started\n\n    this.q.enqueue(this.start);\n  }\n  /**\n   * Set the manager function\n   * @param {function} manager\n   */\n\n\n  setManager(manager) {\n    this.manager = manager;\n  }\n  /**\n   * Require the manager from passed string, or as a class function\n   * @param  {string|object} manager [description]\n   * @return {method}\n   */\n\n\n  requireManager(manager) {\n    var viewManager; // If manager is a string, try to load from imported managers\n\n    if (typeof manager === \"string\" && manager === \"default\") {\n      viewManager = _index.default;\n    } else if (typeof manager === \"string\" && manager === \"continuous\") {\n      viewManager = _index2.default;\n    } else {\n      // otherwise, assume we were passed a class function\n      viewManager = manager;\n    }\n\n    return viewManager;\n  }\n  /**\n   * Require the view from passed string, or as a class function\n   * @param  {string|object} view\n   * @return {view}\n   */\n\n\n  requireView(view) {\n    var View; // If view is a string, try to load from imported views,\n\n    if (typeof view == \"string\" && view === \"iframe\") {\n      View = _iframe.default;\n    } else {\n      // otherwise, assume we were passed a class function\n      View = view;\n    }\n\n    return View;\n  }\n  /**\n   * Start the rendering\n   * @return {Promise} rendering has started\n   */\n\n\n  start() {\n    if (!this.settings.layout && (this.book.package.metadata.layout === \"pre-paginated\" || this.book.displayOptions.fixedLayout === \"true\")) {\n      this.settings.layout = \"pre-paginated\";\n    }\n\n    switch (this.book.package.metadata.spread) {\n      case 'none':\n        this.settings.spread = 'none';\n        break;\n\n      case 'both':\n        this.settings.spread = true;\n        break;\n    }\n\n    if (!this.manager) {\n      this.ViewManager = this.requireManager(this.settings.manager);\n      this.View = this.requireView(this.settings.view);\n      this.manager = new this.ViewManager({\n        view: this.View,\n        queue: this.q,\n        request: this.book.load.bind(this.book),\n        settings: this.settings\n      });\n    }\n\n    this.direction(this.book.package.metadata.direction || this.settings.defaultDirection); // Parse metadata to get layout props\n\n    this.settings.globalLayoutProperties = this.determineLayoutProperties(this.book.package.metadata);\n    this.flow(this.settings.globalLayoutProperties.flow);\n    this.layout(this.settings.globalLayoutProperties); // Listen for displayed views\n\n    this.manager.on(_constants.EVENTS.MANAGERS.ADDED, this.afterDisplayed.bind(this));\n    this.manager.on(_constants.EVENTS.MANAGERS.REMOVED, this.afterRemoved.bind(this)); // Listen for resizing\n\n    this.manager.on(_constants.EVENTS.MANAGERS.RESIZED, this.onResized.bind(this)); // Listen for rotation\n\n    this.manager.on(_constants.EVENTS.MANAGERS.ORIENTATION_CHANGE, this.onOrientationChange.bind(this)); // Listen for scroll changes\n\n    this.manager.on(_constants.EVENTS.MANAGERS.SCROLLED, this.reportLocation.bind(this));\n    /**\n     * Emit that rendering has started\n     * @event started\n     * @memberof Rendition\n     */\n\n    this.emit(_constants.EVENTS.RENDITION.STARTED); // Start processing queue\n\n    this.starting.resolve();\n  }\n  /**\n   * Call to attach the container to an element in the dom\n   * Container must be attached before rendering can begin\n   * @param  {element} element to attach to\n   * @return {Promise}\n   */\n\n\n  attachTo(element) {\n    return this.q.enqueue(function () {\n      // Start rendering\n      this.manager.render(element, {\n        \"width\": this.settings.width,\n        \"height\": this.settings.height\n      });\n      /**\n       * Emit that rendering has attached to an element\n       * @event attached\n       * @memberof Rendition\n       */\n\n      this.emit(_constants.EVENTS.RENDITION.ATTACHED);\n    }.bind(this));\n  }\n  /**\n   * Display a point in the book\n   * The request will be added to the rendering Queue,\n   * so it will wait until book is opened, rendering started\n   * and all other rendering tasks have finished to be called.\n   * @param  {string} target Url or EpubCFI\n   * @return {Promise}\n   */\n\n\n  display(target) {\n    if (this.displaying) {\n      this.displaying.resolve();\n    }\n\n    return this.q.enqueue(this._display, target);\n  }\n  /**\n   * Tells the manager what to display immediately\n   * @private\n   * @param  {string} target Url or EpubCFI\n   * @return {Promise}\n   */\n\n\n  _display(target) {\n    if (!this.book) {\n      return;\n    }\n\n    var isCfiString = this.epubcfi.isCfiString(target);\n    var displaying = new _core.defer();\n    var displayed = displaying.promise;\n    var section;\n    var moveTo;\n    this.displaying = displaying; // Check if this is a book percentage\n\n    if (this.book.locations.length() && (0, _core.isFloat)(target)) {\n      target = this.book.locations.cfiFromPercentage(parseFloat(target));\n    }\n\n    section = this.book.spine.get(target);\n\n    if (!section) {\n      displaying.reject(new Error(\"No Section Found\"));\n      return displayed;\n    }\n\n    this.manager.display(section, target).then(() => {\n      displaying.resolve(section);\n      this.displaying = undefined;\n      /**\n       * Emit that a section has been displayed\n       * @event displayed\n       * @param {Section} section\n       * @memberof Rendition\n       */\n\n      this.emit(_constants.EVENTS.RENDITION.DISPLAYED, section);\n      this.reportLocation();\n    }, err => {\n      /**\n       * Emit that has been an error displaying\n       * @event displayError\n       * @param {Section} section\n       * @memberof Rendition\n       */\n      this.emit(_constants.EVENTS.RENDITION.DISPLAY_ERROR, err);\n    });\n    return displayed;\n  }\n  /*\n  render(view, show) {\n  \t\t// view.onLayout = this.layout.format.bind(this.layout);\n  \tview.create();\n  \t\t// Fit to size of the container, apply padding\n  \tthis.manager.resizeView(view);\n  \t\t// Render Chain\n  \treturn view.section.render(this.book.request)\n  \t\t.then(function(contents){\n  \t\t\treturn view.load(contents);\n  \t\t}.bind(this))\n  \t\t.then(function(doc){\n  \t\t\treturn this.hooks.content.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\tthis.layout.format(view.contents);\n  \t\t\treturn this.hooks.layout.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\treturn view.display();\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\treturn this.hooks.render.trigger(view, this);\n  \t\t}.bind(this))\n  \t\t.then(function(){\n  \t\t\tif(show !== false) {\n  \t\t\t\tthis.q.enqueue(function(view){\n  \t\t\t\t\tview.show();\n  \t\t\t\t}, view);\n  \t\t\t}\n  \t\t\t// this.map = new Map(view, this.layout);\n  \t\t\tthis.hooks.show.trigger(view, this);\n  \t\t\tthis.trigger(\"rendered\", view.section);\n  \t\t\t}.bind(this))\n  \t\t.catch(function(e){\n  \t\t\tthis.trigger(\"loaderror\", e);\n  \t\t}.bind(this));\n  \t}\n  */\n\n  /**\n   * Report what section has been displayed\n   * @private\n   * @param  {*} view\n   */\n\n\n  afterDisplayed(view) {\n    view.on(_constants.EVENTS.VIEWS.MARK_CLICKED, (cfiRange, data) => this.triggerMarkEvent(cfiRange, data, view.contents));\n    this.hooks.render.trigger(view, this).then(() => {\n      if (view.contents) {\n        this.hooks.content.trigger(view.contents, this).then(() => {\n          /**\n           * Emit that a section has been rendered\n           * @event rendered\n           * @param {Section} section\n           * @param {View} view\n           * @memberof Rendition\n           */\n          this.emit(_constants.EVENTS.RENDITION.RENDERED, view.section, view);\n        });\n      } else {\n        this.emit(_constants.EVENTS.RENDITION.RENDERED, view.section, view);\n      }\n    });\n  }\n  /**\n   * Report what has been removed\n   * @private\n   * @param  {*} view\n   */\n\n\n  afterRemoved(view) {\n    this.hooks.unloaded.trigger(view, this).then(() => {\n      /**\n       * Emit that a section has been removed\n       * @event removed\n       * @param {Section} section\n       * @param {View} view\n       * @memberof Rendition\n       */\n      this.emit(_constants.EVENTS.RENDITION.REMOVED, view.section, view);\n    });\n  }\n  /**\n   * Report resize events and display the last seen location\n   * @private\n   */\n\n\n  onResized(size, epubcfi) {\n    /**\n     * Emit that the rendition has been resized\n     * @event resized\n     * @param {number} width\n     * @param {height} height\n     * @param {string} epubcfi (optional)\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.RESIZED, {\n      width: size.width,\n      height: size.height\n    }, epubcfi);\n\n    if (this.location && this.location.start) {\n      this.display(epubcfi || this.location.start.cfi);\n    }\n  }\n  /**\n   * Report orientation events and display the last seen location\n   * @private\n   */\n\n\n  onOrientationChange(orientation) {\n    /**\n     * Emit that the rendition has been rotated\n     * @event orientationchange\n     * @param {string} orientation\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.ORIENTATION_CHANGE, orientation);\n  }\n  /**\n   * Move the Rendition to a specific offset\n   * Usually you would be better off calling display()\n   * @param {object} offset\n   */\n\n\n  moveTo(offset) {\n    this.manager.moveTo(offset);\n  }\n  /**\n   * Trigger a resize of the views\n   * @param {number} [width]\n   * @param {number} [height]\n   * @param {string} [epubcfi] (optional)\n   */\n\n\n  resize(width, height, epubcfi) {\n    if (width) {\n      this.settings.width = width;\n    }\n\n    if (height) {\n      this.settings.height = height;\n    }\n\n    this.manager.resize(width, height, epubcfi);\n  }\n  /**\n   * Clear all rendered views\n   */\n\n\n  clear() {\n    this.manager.clear();\n  }\n  /**\n   * Go to the next \"page\" in the rendition\n   * @return {Promise}\n   */\n\n\n  next() {\n    return this.q.enqueue(this.manager.next.bind(this.manager)).then(this.reportLocation.bind(this));\n  }\n  /**\n   * Go to the previous \"page\" in the rendition\n   * @return {Promise}\n   */\n\n\n  prev() {\n    return this.q.enqueue(this.manager.prev.bind(this.manager)).then(this.reportLocation.bind(this));\n  } //-- http://www.idpf.org/epub/301/spec/epub-publications.html#meta-properties-rendering\n\n  /**\n   * Determine the Layout properties from metadata and settings\n   * @private\n   * @param  {object} metadata\n   * @return {object} properties\n   */\n\n\n  determineLayoutProperties(metadata) {\n    var properties;\n    var layout = this.settings.layout || metadata.layout || \"reflowable\";\n    var spread = this.settings.spread || metadata.spread || \"auto\";\n    var orientation = this.settings.orientation || metadata.orientation || \"auto\";\n    var flow = this.settings.flow || metadata.flow || \"auto\";\n    var viewport = metadata.viewport || \"\";\n    var minSpreadWidth = this.settings.minSpreadWidth || metadata.minSpreadWidth || 800;\n    var direction = this.settings.direction || metadata.direction || \"ltr\";\n\n    if ((this.settings.width === 0 || this.settings.width > 0) && (this.settings.height === 0 || this.settings.height > 0)) {// viewport = \"width=\"+this.settings.width+\", height=\"+this.settings.height+\"\";\n    }\n\n    properties = {\n      layout: layout,\n      spread: spread,\n      orientation: orientation,\n      flow: flow,\n      viewport: viewport,\n      minSpreadWidth: minSpreadWidth,\n      direction: direction\n    };\n    return properties;\n  }\n  /**\n   * Adjust the flow of the rendition to paginated or scrolled\n   * (scrolled-continuous vs scrolled-doc are handled by different view managers)\n   * @param  {string} flow\n   */\n\n\n  flow(flow) {\n    var _flow = flow;\n\n    if (flow === \"scrolled\" || flow === \"scrolled-doc\" || flow === \"scrolled-continuous\") {\n      _flow = \"scrolled\";\n    }\n\n    if (flow === \"auto\" || flow === \"paginated\") {\n      _flow = \"paginated\";\n    }\n\n    this.settings.flow = flow;\n\n    if (this._layout) {\n      this._layout.flow(_flow);\n    }\n\n    if (this.manager && this._layout) {\n      this.manager.applyLayout(this._layout);\n    }\n\n    if (this.manager) {\n      this.manager.updateFlow(_flow);\n    }\n\n    if (this.manager && this.manager.isRendered() && this.location) {\n      this.manager.clear();\n      this.display(this.location.start.cfi);\n    }\n  }\n  /**\n   * Adjust the layout of the rendition to reflowable or pre-paginated\n   * @param  {object} settings\n   */\n\n\n  layout(settings) {\n    if (settings) {\n      this._layout = new _layout.default(settings);\n\n      this._layout.spread(settings.spread, this.settings.minSpreadWidth); // this.mapping = new Mapping(this._layout.props);\n\n\n      this._layout.on(_constants.EVENTS.LAYOUT.UPDATED, (props, changed) => {\n        this.emit(_constants.EVENTS.RENDITION.LAYOUT, props, changed);\n      });\n    }\n\n    if (this.manager && this._layout) {\n      this.manager.applyLayout(this._layout);\n    }\n\n    return this._layout;\n  }\n  /**\n   * Adjust if the rendition uses spreads\n   * @param  {string} spread none | auto (TODO: implement landscape, portrait, both)\n   * @param  {int} [min] min width to use spreads at\n   */\n\n\n  spread(spread, min) {\n    this.settings.spread = spread;\n\n    if (min) {\n      this.settings.minSpreadWidth = min;\n    }\n\n    if (this._layout) {\n      this._layout.spread(spread, min);\n    }\n\n    if (this.manager && this.manager.isRendered()) {\n      this.manager.updateLayout();\n    }\n  }\n  /**\n   * Adjust the direction of the rendition\n   * @param  {string} dir\n   */\n\n\n  direction(dir) {\n    this.settings.direction = dir || \"ltr\";\n\n    if (this.manager) {\n      this.manager.direction(this.settings.direction);\n    }\n\n    if (this.manager && this.manager.isRendered() && this.location) {\n      this.manager.clear();\n      this.display(this.location.start.cfi);\n    }\n  }\n  /**\n   * Report the current location\n   * @fires relocated\n   * @fires locationChanged\n   */\n\n\n  reportLocation() {\n    return this.q.enqueue(function reportedLocation() {\n      requestAnimationFrame(function reportedLocationAfterRAF() {\n        var location = this.manager.currentLocation();\n\n        if (location && location.then && typeof location.then === \"function\") {\n          location.then(function (result) {\n            let located = this.located(result);\n\n            if (!located || !located.start || !located.end) {\n              return;\n            }\n\n            this.location = located;\n            this.emit(_constants.EVENTS.RENDITION.LOCATION_CHANGED, {\n              index: this.location.start.index,\n              href: this.location.start.href,\n              start: this.location.start.cfi,\n              end: this.location.end.cfi,\n              percentage: this.location.start.percentage\n            });\n            this.emit(_constants.EVENTS.RENDITION.RELOCATED, this.location);\n          }.bind(this));\n        } else if (location) {\n          let located = this.located(location);\n\n          if (!located || !located.start || !located.end) {\n            return;\n          }\n\n          this.location = located;\n          /**\n           * @event locationChanged\n           * @deprecated\n           * @type {object}\n           * @property {number} index\n           * @property {string} href\n           * @property {EpubCFI} start\n           * @property {EpubCFI} end\n           * @property {number} percentage\n           * @memberof Rendition\n           */\n\n          this.emit(_constants.EVENTS.RENDITION.LOCATION_CHANGED, {\n            index: this.location.start.index,\n            href: this.location.start.href,\n            start: this.location.start.cfi,\n            end: this.location.end.cfi,\n            percentage: this.location.start.percentage\n          });\n          /**\n           * @event relocated\n           * @type {displayedLocation}\n           * @memberof Rendition\n           */\n\n          this.emit(_constants.EVENTS.RENDITION.RELOCATED, this.location);\n        }\n      }.bind(this));\n    }.bind(this));\n  }\n  /**\n   * Get the Current Location object\n   * @return {displayedLocation | promise} location (may be a promise)\n   */\n\n\n  currentLocation() {\n    var location = this.manager.currentLocation();\n\n    if (location && location.then && typeof location.then === \"function\") {\n      location.then(function (result) {\n        let located = this.located(result);\n        return located;\n      }.bind(this));\n    } else if (location) {\n      let located = this.located(location);\n      return located;\n    }\n  }\n  /**\n   * Creates a Rendition#locationRange from location\n   * passed by the Manager\n   * @returns {displayedLocation}\n   * @private\n   */\n\n\n  located(location) {\n    if (!location.length) {\n      return {};\n    }\n\n    let start = location[0];\n    let end = location[location.length - 1];\n    let located = {\n      start: {\n        index: start.index,\n        href: start.href,\n        cfi: start.mapping.start,\n        displayed: {\n          page: start.pages[0] || 1,\n          total: start.totalPages\n        }\n      },\n      end: {\n        index: end.index,\n        href: end.href,\n        cfi: end.mapping.end,\n        displayed: {\n          page: end.pages[end.pages.length - 1] || 1,\n          total: end.totalPages\n        }\n      }\n    };\n    let locationStart = this.book.locations.locationFromCfi(start.mapping.start);\n    let locationEnd = this.book.locations.locationFromCfi(end.mapping.end);\n\n    if (locationStart != null) {\n      located.start.location = locationStart;\n      located.start.percentage = this.book.locations.percentageFromLocation(locationStart);\n    }\n\n    if (locationEnd != null) {\n      located.end.location = locationEnd;\n      located.end.percentage = this.book.locations.percentageFromLocation(locationEnd);\n    }\n\n    let pageStart = this.book.pageList.pageFromCfi(start.mapping.start);\n    let pageEnd = this.book.pageList.pageFromCfi(end.mapping.end);\n\n    if (pageStart != -1) {\n      located.start.page = pageStart;\n    }\n\n    if (pageEnd != -1) {\n      located.end.page = pageEnd;\n    }\n\n    if (end.index === this.book.spine.last().index && located.end.displayed.page >= located.end.displayed.total) {\n      located.atEnd = true;\n    }\n\n    if (start.index === this.book.spine.first().index && located.start.displayed.page === 1) {\n      located.atStart = true;\n    }\n\n    return located;\n  }\n  /**\n   * Remove and Clean Up the Rendition\n   */\n\n\n  destroy() {\n    // Clear the queue\n    // this.q.clear();\n    // this.q = undefined;\n    this.manager && this.manager.destroy();\n    this.book = undefined; // this.views = null;\n    // this.hooks.display.clear();\n    // this.hooks.serialize.clear();\n    // this.hooks.content.clear();\n    // this.hooks.layout.clear();\n    // this.hooks.render.clear();\n    // this.hooks.show.clear();\n    // this.hooks = {};\n    // this.themes.destroy();\n    // this.themes = undefined;\n    // this.epubcfi = undefined;\n    // this.starting = undefined;\n    // this.started = undefined;\n  }\n  /**\n   * Pass the events from a view's Contents\n   * @private\n   * @param  {Contents} view contents\n   */\n\n\n  passEvents(contents) {\n    _constants.DOM_EVENTS.forEach(e => {\n      contents.on(e, ev => this.triggerViewEvent(ev, contents));\n    });\n\n    contents.on(_constants.EVENTS.CONTENTS.SELECTED, e => this.triggerSelectedEvent(e, contents));\n  }\n  /**\n   * Emit events passed by a view\n   * @private\n   * @param  {event} e\n   */\n\n\n  triggerViewEvent(e, contents) {\n    this.emit(e.type, e, contents);\n  }\n  /**\n   * Emit a selection event's CFI Range passed from a a view\n   * @private\n   * @param  {string} cfirange\n   */\n\n\n  triggerSelectedEvent(cfirange, contents) {\n    /**\n     * Emit that a text selection has occurred\n     * @event selected\n     * @param {string} cfirange\n     * @param {Contents} contents\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.SELECTED, cfirange, contents);\n  }\n  /**\n   * Emit a markClicked event with the cfiRange and data from a mark\n   * @private\n   * @param  {EpubCFI} cfirange\n   */\n\n\n  triggerMarkEvent(cfiRange, data, contents) {\n    /**\n     * Emit that a mark was clicked\n     * @event markClicked\n     * @param {EpubCFI} cfirange\n     * @param {object} data\n     * @param {Contents} contents\n     * @memberof Rendition\n     */\n    this.emit(_constants.EVENTS.RENDITION.MARK_CLICKED, cfiRange, data, contents);\n  }\n  /**\n   * Get a Range from a Visible CFI\n   * @param  {string} cfi EpubCfi String\n   * @param  {string} ignoreClass\n   * @return {range}\n   */\n\n\n  getRange(cfi, ignoreClass) {\n    var _cfi = new _epubcfi.default(cfi);\n\n    var found = this.manager.visible().filter(function (view) {\n      if (_cfi.spinePos === view.index) return true;\n    }); // Should only every return 1 item\n\n    if (found.length) {\n      return found[0].contents.range(_cfi, ignoreClass);\n    }\n  }\n  /**\n   * Hook to adjust images to fit in columns\n   * @param  {Contents} contents\n   * @private\n   */\n\n\n  adjustImages(contents) {\n    if (this._layout.name === \"pre-paginated\") {\n      return new Promise(function (resolve) {\n        resolve();\n      });\n    }\n\n    let computed = contents.window.getComputedStyle(contents.content, null);\n    let height = (contents.content.offsetHeight - (parseFloat(computed.paddingTop) + parseFloat(computed.paddingBottom))) * .95;\n    let horizontalPadding = parseFloat(computed.paddingLeft) + parseFloat(computed.paddingRight);\n    contents.addStylesheetRules({\n      \"img\": {\n        \"max-width\": (this._layout.columnWidth ? this._layout.columnWidth - horizontalPadding + \"px\" : \"100%\") + \"!important\",\n        \"max-height\": height + \"px\" + \"!important\",\n        \"object-fit\": \"contain\",\n        \"page-break-inside\": \"avoid\",\n        \"break-inside\": \"avoid\",\n        \"box-sizing\": \"border-box\"\n      },\n      \"svg\": {\n        \"max-width\": (this._layout.columnWidth ? this._layout.columnWidth - horizontalPadding + \"px\" : \"100%\") + \"!important\",\n        \"max-height\": height + \"px\" + \"!important\",\n        \"page-break-inside\": \"avoid\",\n        \"break-inside\": \"avoid\"\n      }\n    });\n    return new Promise(function (resolve, reject) {\n      // Wait to apply\n      setTimeout(function () {\n        resolve();\n      }, 1);\n    });\n  }\n  /**\n   * Get the Contents object of each rendered view\n   * @returns {Contents[]}\n   */\n\n\n  getContents() {\n    return this.manager ? this.manager.getContents() : [];\n  }\n  /**\n   * Get the views member from the manager\n   * @returns {Views}\n   */\n\n\n  views() {\n    let views = this.manager ? this.manager.views : undefined;\n    return views || [];\n  }\n  /**\n   * Hook to handle link clicks in rendered content\n   * @param  {Contents} contents\n   * @private\n   */\n\n\n  handleLinks(contents) {\n    if (contents) {\n      contents.on(_constants.EVENTS.CONTENTS.LINK_CLICKED, href => {\n        let relative = this.book.path.relative(href);\n        this.display(relative);\n      });\n    }\n  }\n  /**\n   * Hook to handle injecting stylesheet before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectStylesheet(doc, section) {\n    let style = doc.createElement(\"link\");\n    style.setAttribute(\"type\", \"text/css\");\n    style.setAttribute(\"rel\", \"stylesheet\");\n    style.setAttribute(\"href\", this.settings.stylesheet);\n    doc.getElementsByTagName(\"head\")[0].appendChild(style);\n  }\n  /**\n   * Hook to handle injecting scripts before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectScript(doc, section) {\n    let script = doc.createElement(\"script\");\n    script.setAttribute(\"type\", \"text/javascript\");\n    script.setAttribute(\"src\", this.settings.script);\n    script.textContent = \" \"; // Needed to prevent self closing tag\n\n    doc.getElementsByTagName(\"head\")[0].appendChild(script);\n  }\n  /**\n   * Hook to handle the document identifier before\n   * a Section is serialized\n   * @param  {document} doc\n   * @param  {Section} section\n   * @private\n   */\n\n\n  injectIdentifier(doc, section) {\n    let ident = this.book.packaging.metadata.identifier;\n    let meta = doc.createElement(\"meta\");\n    meta.setAttribute(\"name\", \"dc.relation.ispartof\");\n\n    if (ident) {\n      meta.setAttribute(\"content\", ident);\n    }\n\n    doc.getElementsByTagName(\"head\")[0].appendChild(meta);\n  }\n\n} //-- Enable binding events to Renderer\n\n\n(0, _eventEmitter.default)(Rendition.prototype);\nvar _default = Rendition;\nexports.default = _default;"]},"metadata":{},"sourceType":"script"}