{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"./utils/core\");\n\nvar _epubcfi = _interopRequireDefault(require(\"./epubcfi\"));\n\nvar _mapping = _interopRequireDefault(require(\"./mapping\"));\n\nvar _replacements = require(\"./utils/replacements\");\n\nvar _constants = require(\"./utils/constants\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nconst hasNavigator = typeof navigator !== \"undefined\";\nconst isChrome = hasNavigator && /Chrome/.test(navigator.userAgent);\nconst isWebkit = hasNavigator && !isChrome && /AppleWebKit/.test(navigator.userAgent);\nconst ELEMENT_NODE = 1;\nconst TEXT_NODE = 3;\n/**\n\t* Handles DOM manipulation, queries and events for View contents\n\t* @class\n\t* @param {document} doc Document\n\t* @param {element} content Parent Element (typically Body)\n\t* @param {string} cfiBase Section component of CFIs\n\t* @param {number} sectionIndex Index in Spine of Conntent's Section\n\t*/\n\nclass Contents {\n  constructor(doc, content, cfiBase, sectionIndex) {\n    // Blank Cfi for Parsing\n    this.epubcfi = new _epubcfi.default();\n    this.document = doc;\n    this.documentElement = this.document.documentElement;\n    this.content = content || this.document.body;\n    this.window = this.document.defaultView;\n    this._size = {\n      width: 0,\n      height: 0\n    };\n    this.sectionIndex = sectionIndex || 0;\n    this.cfiBase = cfiBase || \"\";\n    this.epubReadingSystem(\"epub.js\", _constants.EPUBJS_VERSION);\n    this.called = 0;\n    this.active = true;\n    this.listeners();\n  }\n  /**\n  \t* Get DOM events that are listened for and passed along\n  \t*/\n\n\n  static get listenedEvents() {\n    return _constants.DOM_EVENTS;\n  }\n  /**\n  \t* Get or Set width\n  \t* @param {number} [w]\n  \t* @returns {number} width\n  \t*/\n\n\n  width(w) {\n    // var frame = this.documentElement;\n    var frame = this.content;\n\n    if (w && (0, _core.isNumber)(w)) {\n      w = w + \"px\";\n    }\n\n    if (w) {\n      frame.style.width = w; // this.content.style.width = w;\n    }\n\n    return parseInt(this.window.getComputedStyle(frame)[\"width\"]);\n  }\n  /**\n  \t* Get or Set height\n  \t* @param {number} [h]\n  \t* @returns {number} height\n  \t*/\n\n\n  height(h) {\n    // var frame = this.documentElement;\n    var frame = this.content;\n\n    if (h && (0, _core.isNumber)(h)) {\n      h = h + \"px\";\n    }\n\n    if (h) {\n      frame.style.height = h; // this.content.style.height = h;\n    }\n\n    return parseInt(this.window.getComputedStyle(frame)[\"height\"]);\n  }\n  /**\n  \t* Get or Set width of the contents\n  \t* @param {number} [w]\n  \t* @returns {number} width\n  \t*/\n\n\n  contentWidth(w) {\n    var content = this.content || this.document.body;\n\n    if (w && (0, _core.isNumber)(w)) {\n      w = w + \"px\";\n    }\n\n    if (w) {\n      content.style.width = w;\n    }\n\n    return parseInt(this.window.getComputedStyle(content)[\"width\"]);\n  }\n  /**\n  \t* Get or Set height of the contents\n  \t* @param {number} [h]\n  \t* @returns {number} height\n  \t*/\n\n\n  contentHeight(h) {\n    var content = this.content || this.document.body;\n\n    if (h && (0, _core.isNumber)(h)) {\n      h = h + \"px\";\n    }\n\n    if (h) {\n      content.style.height = h;\n    }\n\n    return parseInt(this.window.getComputedStyle(content)[\"height\"]);\n  }\n  /**\n  \t* Get the width of the text using Range\n  \t* @returns {number} width\n  \t*/\n\n\n  textWidth() {\n    let rect;\n    let width;\n    let range = this.document.createRange();\n    let content = this.content || this.document.body;\n    let border = (0, _core.borders)(content); // Select the contents of frame\n\n    range.selectNodeContents(content); // get the width of the text content\n\n    rect = range.getBoundingClientRect();\n    width = rect.width;\n\n    if (border && border.width) {\n      width += border.width;\n    }\n\n    return Math.round(width);\n  }\n  /**\n  \t* Get the height of the text using Range\n  \t* @returns {number} height\n  \t*/\n\n\n  textHeight() {\n    let rect;\n    let height;\n    let range = this.document.createRange();\n    let content = this.content || this.document.body;\n    range.selectNodeContents(content);\n    rect = range.getBoundingClientRect();\n    height = rect.bottom;\n    return Math.round(height);\n  }\n  /**\n  \t* Get documentElement scrollWidth\n  \t* @returns {number} width\n  \t*/\n\n\n  scrollWidth() {\n    var width = this.documentElement.scrollWidth;\n    return width;\n  }\n  /**\n  \t* Get documentElement scrollHeight\n  \t* @returns {number} height\n  \t*/\n\n\n  scrollHeight() {\n    var height = this.documentElement.scrollHeight;\n    return height;\n  }\n  /**\n  \t* Set overflow css style of the contents\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflow(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflow = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflow\"];\n  }\n  /**\n  \t* Set overflowX css style of the documentElement\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflowX(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflowX = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflowX\"];\n  }\n  /**\n  \t* Set overflowY css style of the documentElement\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflowY(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflowY = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflowY\"];\n  }\n  /**\n  \t* Set Css styles on the contents element (typically Body)\n  \t* @param {string} property\n  \t* @param {string} value\n  \t* @param {boolean} [priority] set as \"important\"\n  \t*/\n\n\n  css(property, value, priority) {\n    var content = this.content || this.document.body;\n\n    if (value) {\n      content.style.setProperty(property, value, priority ? \"important\" : \"\");\n    } else {\n      content.style.removeProperty(property);\n    }\n\n    return this.window.getComputedStyle(content)[property];\n  }\n  /**\n  \t* Get or Set the viewport element\n  \t* @param {object} [options]\n  \t* @param {string} [options.width]\n  \t* @param {string} [options.height]\n  \t* @param {string} [options.scale]\n  \t* @param {string} [options.minimum]\n  \t* @param {string} [options.maximum]\n  \t* @param {string} [options.scalable]\n  \t*/\n\n\n  viewport(options) {\n    var _width, _height, _scale, _minimum, _maximum, _scalable; // var width, height, scale, minimum, maximum, scalable;\n\n\n    var $viewport = this.document.querySelector(\"meta[name='viewport']\");\n    var parsed = {\n      \"width\": undefined,\n      \"height\": undefined,\n      \"scale\": undefined,\n      \"minimum\": undefined,\n      \"maximum\": undefined,\n      \"scalable\": undefined\n    };\n    var newContent = [];\n    var settings = {};\n    /*\n    * check for the viewport size\n    * <meta name=\"viewport\" content=\"width=1024,height=697\" />\n    */\n\n    if ($viewport && $viewport.hasAttribute(\"content\")) {\n      let content = $viewport.getAttribute(\"content\");\n\n      let _width = content.match(/width\\s*=\\s*([^,]*)/);\n\n      let _height = content.match(/height\\s*=\\s*([^,]*)/);\n\n      let _scale = content.match(/initial-scale\\s*=\\s*([^,]*)/);\n\n      let _minimum = content.match(/minimum-scale\\s*=\\s*([^,]*)/);\n\n      let _maximum = content.match(/maximum-scale\\s*=\\s*([^,]*)/);\n\n      let _scalable = content.match(/user-scalable\\s*=\\s*([^,]*)/);\n\n      if (_width && _width.length && typeof _width[1] !== \"undefined\") {\n        parsed.width = _width[1];\n      }\n\n      if (_height && _height.length && typeof _height[1] !== \"undefined\") {\n        parsed.height = _height[1];\n      }\n\n      if (_scale && _scale.length && typeof _scale[1] !== \"undefined\") {\n        parsed.scale = _scale[1];\n      }\n\n      if (_minimum && _minimum.length && typeof _minimum[1] !== \"undefined\") {\n        parsed.minimum = _minimum[1];\n      }\n\n      if (_maximum && _maximum.length && typeof _maximum[1] !== \"undefined\") {\n        parsed.maximum = _maximum[1];\n      }\n\n      if (_scalable && _scalable.length && typeof _scalable[1] !== \"undefined\") {\n        parsed.scalable = _scalable[1];\n      }\n    }\n\n    settings = (0, _core.defaults)(options || {}, parsed);\n\n    if (options) {\n      if (settings.width) {\n        newContent.push(\"width=\" + settings.width);\n      }\n\n      if (settings.height) {\n        newContent.push(\"height=\" + settings.height);\n      }\n\n      if (settings.scale) {\n        newContent.push(\"initial-scale=\" + settings.scale);\n      }\n\n      if (settings.scalable === \"no\") {\n        newContent.push(\"minimum-scale=\" + settings.scale);\n        newContent.push(\"maximum-scale=\" + settings.scale);\n        newContent.push(\"user-scalable=\" + settings.scalable);\n      } else {\n        if (settings.scalable) {\n          newContent.push(\"user-scalable=\" + settings.scalable);\n        }\n\n        if (settings.minimum) {\n          newContent.push(\"minimum-scale=\" + settings.minimum);\n        }\n\n        if (settings.maximum) {\n          newContent.push(\"minimum-scale=\" + settings.maximum);\n        }\n      }\n\n      if (!$viewport) {\n        $viewport = this.document.createElement(\"meta\");\n        $viewport.setAttribute(\"name\", \"viewport\");\n        this.document.querySelector(\"head\").appendChild($viewport);\n      }\n\n      $viewport.setAttribute(\"content\", newContent.join(\", \"));\n      this.window.scrollTo(0, 0);\n    }\n\n    return settings;\n  }\n  /**\n   * Event emitter for when the contents has expanded\n   * @private\n   */\n\n\n  expand() {\n    this.emit(_constants.EVENTS.CONTENTS.EXPAND);\n  }\n  /**\n   * Add DOM listeners\n   * @private\n   */\n\n\n  listeners() {\n    this.imageLoadListeners();\n    this.mediaQueryListeners(); // this.fontLoadListeners();\n\n    this.addEventListeners();\n    this.addSelectionListeners(); // this.transitionListeners();\n\n    if (typeof ResizeObserver === \"undefined\") {\n      this.resizeListeners();\n      this.visibilityListeners();\n    } else {\n      this.resizeObservers();\n    } // this.mutationObservers();\n\n\n    this.linksHandler();\n  }\n  /**\n   * Remove DOM listeners\n   * @private\n   */\n\n\n  removeListeners() {\n    this.removeEventListeners();\n    this.removeSelectionListeners();\n\n    if (this.observer) {\n      this.observer.disconnect();\n    }\n\n    clearTimeout(this.expanding);\n  }\n  /**\n   * Check if size of contents has changed and\n   * emit 'resize' event if it has.\n   * @private\n   */\n\n\n  resizeCheck() {\n    let width = this.textWidth();\n    let height = this.textHeight();\n\n    if (width != this._size.width || height != this._size.height) {\n      this._size = {\n        width: width,\n        height: height\n      };\n      this.onResize && this.onResize(this._size);\n      this.emit(_constants.EVENTS.CONTENTS.RESIZE, this._size);\n    }\n  }\n  /**\n   * Poll for resize detection\n   * @private\n   */\n\n\n  resizeListeners() {\n    var width, height; // Test size again\n\n    clearTimeout(this.expanding);\n    requestAnimationFrame(this.resizeCheck.bind(this));\n    this.expanding = setTimeout(this.resizeListeners.bind(this), 350);\n  }\n  /**\n   * Listen for visibility of tab to change\n   * @private\n   */\n\n\n  visibilityListeners() {\n    document.addEventListener(\"visibilitychange\", () => {\n      if (document.visibilityState === \"visible\" && this.active === false) {\n        this.active = true;\n        this.resizeListeners();\n      } else {\n        this.active = false;\n        clearTimeout(this.expanding);\n      }\n    });\n  }\n  /**\n   * Use css transitions to detect resize\n   * @private\n   */\n\n\n  transitionListeners() {\n    let body = this.content;\n    body.style['transitionProperty'] = \"font, font-size, font-size-adjust, font-stretch, font-variation-settings, font-weight, width, height\";\n    body.style['transitionDuration'] = \"0.001ms\";\n    body.style['transitionTimingFunction'] = \"linear\";\n    body.style['transitionDelay'] = \"0\";\n    this._resizeCheck = this.resizeCheck.bind(this);\n    this.document.addEventListener('transitionend', this._resizeCheck);\n  }\n  /**\n   * Listen for media query changes and emit 'expand' event\n   * Adapted from: https://github.com/tylergaw/media-query-events/blob/master/js/mq-events.js\n   * @private\n   */\n\n\n  mediaQueryListeners() {\n    var sheets = this.document.styleSheets;\n\n    var mediaChangeHandler = function (m) {\n      if (m.matches && !this._expanding) {\n        setTimeout(this.expand.bind(this), 1);\n      }\n    }.bind(this);\n\n    for (var i = 0; i < sheets.length; i += 1) {\n      var rules; // Firefox errors if we access cssRules cross-domain\n\n      try {\n        rules = sheets[i].cssRules;\n      } catch (e) {\n        return;\n      }\n\n      if (!rules) return; // Stylesheets changed\n\n      for (var j = 0; j < rules.length; j += 1) {\n        //if (rules[j].constructor === CSSMediaRule) {\n        if (rules[j].media) {\n          var mql = this.window.matchMedia(rules[j].media.mediaText);\n          mql.addListener(mediaChangeHandler); //mql.onchange = mediaChangeHandler;\n        }\n      }\n    }\n  }\n  /**\n   * Use ResizeObserver to listen for changes in the DOM and check for resize\n   * @private\n   */\n\n\n  resizeObservers() {\n    // create an observer instance\n    this.observer = new ResizeObserver(e => {\n      requestAnimationFrame(this.resizeCheck.bind(this));\n    }); // pass in the target node\n\n    this.observer.observe(this.document.documentElement);\n  }\n  /**\n   * Use MutationObserver to listen for changes in the DOM and check for resize\n   * @private\n   */\n\n\n  mutationObservers() {\n    // create an observer instance\n    this.observer = new MutationObserver(mutations => {\n      this.resizeCheck();\n    }); // configuration of the observer:\n\n    let config = {\n      attributes: true,\n      childList: true,\n      characterData: true,\n      subtree: true\n    }; // pass in the target node, as well as the observer options\n\n    this.observer.observe(this.document, config);\n  }\n  /**\n   * Test if images are loaded or add listener for when they load\n   * @private\n   */\n\n\n  imageLoadListeners() {\n    var images = this.document.querySelectorAll(\"img\");\n    var img;\n\n    for (var i = 0; i < images.length; i++) {\n      img = images[i];\n\n      if (typeof img.naturalWidth !== \"undefined\" && img.naturalWidth === 0) {\n        img.onload = this.expand.bind(this);\n      }\n    }\n  }\n  /**\n   * Listen for font load and check for resize when loaded\n   * @private\n   */\n\n\n  fontLoadListeners() {\n    if (!this.document || !this.document.fonts) {\n      return;\n    }\n\n    this.document.fonts.ready.then(function () {\n      this.resizeCheck();\n    }.bind(this));\n  }\n  /**\n   * Get the documentElement\n   * @returns {element} documentElement\n   */\n\n\n  root() {\n    if (!this.document) return null;\n    return this.document.documentElement;\n  }\n  /**\n   * Get the location offset of a EpubCFI or an #id\n   * @param {string | EpubCFI} target\n   * @param {string} [ignoreClass] for the cfi\n   * @returns { {left: Number, top: Number }\n   */\n\n\n  locationOf(target, ignoreClass) {\n    var position;\n    var targetPos = {\n      \"left\": 0,\n      \"top\": 0\n    };\n    if (!this.document) return targetPos;\n\n    if (this.epubcfi.isCfiString(target)) {\n      let range = new _epubcfi.default(target).toRange(this.document, ignoreClass);\n\n      if (range) {\n        try {\n          if (!range.endContainer || range.startContainer == range.endContainer && range.startOffset == range.endOffset) {\n            // If the end for the range is not set, it results in collapsed becoming\n            // true. This in turn leads to inconsistent behaviour when calling\n            // getBoundingRect. Wrong bounds lead to the wrong page being displayed.\n            // https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/15684911/\n            let pos = range.startContainer.textContent.indexOf(\" \", range.startOffset);\n\n            if (pos == -1) {\n              pos = range.startContainer.textContent.length;\n            }\n\n            range.setEnd(range.startContainer, pos);\n          }\n        } catch (e) {\n          console.error(\"setting end offset to start container length failed\", e);\n        }\n\n        if (range.startContainer.nodeType === Node.ELEMENT_NODE) {\n          position = range.startContainer.getBoundingClientRect();\n          targetPos.left = position.left;\n          targetPos.top = position.top;\n        } else {\n          // Webkit does not handle collapsed range bounds correctly\n          // https://bugs.webkit.org/show_bug.cgi?id=138949\n          // Construct a new non-collapsed range\n          if (isWebkit) {\n            let container = range.startContainer;\n            let newRange = new Range();\n\n            try {\n              if (container.nodeType === ELEMENT_NODE) {\n                position = container.getBoundingClientRect();\n              } else if (range.startOffset + 2 < container.length) {\n                newRange.setStart(container, range.startOffset);\n                newRange.setEnd(container, range.startOffset + 2);\n                position = newRange.getBoundingClientRect();\n              } else if (range.startOffset - 2 > 0) {\n                newRange.setStart(container, range.startOffset - 2);\n                newRange.setEnd(container, range.startOffset);\n                position = newRange.getBoundingClientRect();\n              } else {\n                // empty, return the parent element\n                position = container.parentNode.getBoundingClientRect();\n              }\n            } catch (e) {\n              console.error(e, e.stack);\n            }\n          } else {\n            position = range.getBoundingClientRect();\n          }\n        }\n      }\n    } else if (typeof target === \"string\" && target.indexOf(\"#\") > -1) {\n      let id = target.substring(target.indexOf(\"#\") + 1);\n      let el = this.document.getElementById(id);\n\n      if (el) {\n        if (isWebkit) {\n          // Webkit reports incorrect bounding rects in Columns\n          let newRange = new Range();\n          newRange.selectNode(el);\n          position = newRange.getBoundingClientRect();\n        } else {\n          position = el.getBoundingClientRect();\n        }\n      }\n    }\n\n    if (position) {\n      targetPos.left = position.left;\n      targetPos.top = position.top;\n    }\n\n    return targetPos;\n  }\n  /**\n   * Append a stylesheet link to the document head\n   * @param {string} src url\n   */\n\n\n  addStylesheet(src) {\n    return new Promise(function (resolve, reject) {\n      var $stylesheet;\n      var ready = false;\n\n      if (!this.document) {\n        resolve(false);\n        return;\n      } // Check if link already exists\n\n\n      $stylesheet = this.document.querySelector(\"link[href='\" + src + \"']\");\n\n      if ($stylesheet) {\n        resolve(true);\n        return; // already present\n      }\n\n      $stylesheet = this.document.createElement(\"link\");\n      $stylesheet.type = \"text/css\";\n      $stylesheet.rel = \"stylesheet\";\n      $stylesheet.href = src;\n\n      $stylesheet.onload = $stylesheet.onreadystatechange = function () {\n        if (!ready && (!this.readyState || this.readyState == \"complete\")) {\n          ready = true; // Let apply\n\n          setTimeout(() => {\n            resolve(true);\n          }, 1);\n        }\n      };\n\n      this.document.head.appendChild($stylesheet);\n    }.bind(this));\n  }\n\n  _getStylesheetNode(key) {\n    var styleEl;\n    key = \"epubjs-inserted-css-\" + (key || '');\n    if (!this.document) return false; // Check if link already exists\n\n    styleEl = this.document.getElementById(key);\n\n    if (!styleEl) {\n      styleEl = this.document.createElement(\"style\");\n      styleEl.id = key; // Append style element to head\n\n      this.document.head.appendChild(styleEl);\n    }\n\n    return styleEl;\n  }\n  /**\n   * Append stylesheet css\n   * @param {string} serializedCss\n   * @param {string} key If the key is the same, the CSS will be replaced instead of inserted\n   */\n\n\n  addStylesheetCss(serializedCss, key) {\n    if (!this.document || !serializedCss) return false;\n    var styleEl;\n    styleEl = this._getStylesheetNode(key);\n    styleEl.innerHTML = serializedCss;\n    return true;\n  }\n  /**\n   * Append stylesheet rules to a generate stylesheet\n   * Array: https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule\n   * Object: https://github.com/desirable-objects/json-to-css\n   * @param {array | object} rules\n   * @param {string} key If the key is the same, the CSS will be replaced instead of inserted\n   */\n\n\n  addStylesheetRules(rules, key) {\n    var styleSheet;\n    if (!this.document || !rules || rules.length === 0) return; // Grab style sheet\n\n    styleSheet = this._getStylesheetNode(key).sheet;\n\n    if (Object.prototype.toString.call(rules) === \"[object Array]\") {\n      for (var i = 0, rl = rules.length; i < rl; i++) {\n        var j = 1,\n            rule = rules[i],\n            selector = rules[i][0],\n            propStr = \"\"; // If the second argument of a rule is an array of arrays, correct our variables.\n\n        if (Object.prototype.toString.call(rule[1][0]) === \"[object Array]\") {\n          rule = rule[1];\n          j = 0;\n        }\n\n        for (var pl = rule.length; j < pl; j++) {\n          var prop = rule[j];\n          propStr += prop[0] + \":\" + prop[1] + (prop[2] ? \" !important\" : \"\") + \";\\n\";\n        } // Insert CSS Rule\n\n\n        styleSheet.insertRule(selector + \"{\" + propStr + \"}\", styleSheet.cssRules.length);\n      }\n    } else {\n      const selectors = Object.keys(rules);\n      selectors.forEach(selector => {\n        const definition = rules[selector];\n\n        if (Array.isArray(definition)) {\n          definition.forEach(item => {\n            const _rules = Object.keys(item);\n\n            const result = _rules.map(rule => {\n              return `${rule}:${item[rule]}`;\n            }).join(';');\n\n            styleSheet.insertRule(`${selector}{${result}}`, styleSheet.cssRules.length);\n          });\n        } else {\n          const _rules = Object.keys(definition);\n\n          const result = _rules.map(rule => {\n            return `${rule}:${definition[rule]}`;\n          }).join(';');\n\n          styleSheet.insertRule(`${selector}{${result}}`, styleSheet.cssRules.length);\n        }\n      });\n    }\n  }\n  /**\n   * Append a script tag to the document head\n   * @param {string} src url\n   * @returns {Promise} loaded\n   */\n\n\n  addScript(src) {\n    return new Promise(function (resolve, reject) {\n      var $script;\n      var ready = false;\n\n      if (!this.document) {\n        resolve(false);\n        return;\n      }\n\n      $script = this.document.createElement(\"script\");\n      $script.type = \"text/javascript\";\n      $script.async = true;\n      $script.src = src;\n\n      $script.onload = $script.onreadystatechange = function () {\n        if (!ready && (!this.readyState || this.readyState == \"complete\")) {\n          ready = true;\n          setTimeout(function () {\n            resolve(true);\n          }, 1);\n        }\n      };\n\n      this.document.head.appendChild($script);\n    }.bind(this));\n  }\n  /**\n   * Add a class to the contents container\n   * @param {string} className\n   */\n\n\n  addClass(className) {\n    var content;\n    if (!this.document) return;\n    content = this.content || this.document.body;\n\n    if (content) {\n      content.classList.add(className);\n    }\n  }\n  /**\n   * Remove a class from the contents container\n   * @param {string} removeClass\n   */\n\n\n  removeClass(className) {\n    var content;\n    if (!this.document) return;\n    content = this.content || this.document.body;\n\n    if (content) {\n      content.classList.remove(className);\n    }\n  }\n  /**\n   * Add DOM event listeners\n   * @private\n   */\n\n\n  addEventListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this._triggerEvent = this.triggerEvent.bind(this);\n\n    _constants.DOM_EVENTS.forEach(function (eventName) {\n      this.document.addEventListener(eventName, this._triggerEvent, {\n        passive: true\n      });\n    }, this);\n  }\n  /**\n   * Remove DOM event listeners\n   * @private\n   */\n\n\n  removeEventListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    _constants.DOM_EVENTS.forEach(function (eventName) {\n      this.document.removeEventListener(eventName, this._triggerEvent, {\n        passive: true\n      });\n    }, this);\n\n    this._triggerEvent = undefined;\n  }\n  /**\n   * Emit passed browser events\n   * @private\n   */\n\n\n  triggerEvent(e) {\n    this.emit(e.type, e);\n  }\n  /**\n   * Add listener for text selection\n   * @private\n   */\n\n\n  addSelectionListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this._onSelectionChange = this.onSelectionChange.bind(this);\n    this.document.addEventListener(\"selectionchange\", this._onSelectionChange, {\n      passive: true\n    });\n  }\n  /**\n   * Remove listener for text selection\n   * @private\n   */\n\n\n  removeSelectionListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this.document.removeEventListener(\"selectionchange\", this._onSelectionChange, {\n      passive: true\n    });\n    this._onSelectionChange = undefined;\n  }\n  /**\n   * Handle getting text on selection\n   * @private\n   */\n\n\n  onSelectionChange(e) {\n    if (this.selectionEndTimeout) {\n      clearTimeout(this.selectionEndTimeout);\n    }\n\n    this.selectionEndTimeout = setTimeout(function () {\n      var selection = this.window.getSelection();\n      this.triggerSelectedEvent(selection);\n    }.bind(this), 250);\n  }\n  /**\n   * Emit event on text selection\n   * @private\n   */\n\n\n  triggerSelectedEvent(selection) {\n    var range, cfirange;\n\n    if (selection && selection.rangeCount > 0) {\n      range = selection.getRangeAt(0);\n\n      if (!range.collapsed) {\n        // cfirange = this.section.cfiFromRange(range);\n        cfirange = new _epubcfi.default(range, this.cfiBase).toString();\n        this.emit(_constants.EVENTS.CONTENTS.SELECTED, cfirange);\n        this.emit(_constants.EVENTS.CONTENTS.SELECTED_RANGE, range);\n      }\n    }\n  }\n  /**\n   * Get a Dom Range from EpubCFI\n   * @param {EpubCFI} _cfi\n   * @param {string} [ignoreClass]\n   * @returns {Range} range\n   */\n\n\n  range(_cfi, ignoreClass) {\n    var cfi = new _epubcfi.default(_cfi);\n    return cfi.toRange(this.document, ignoreClass);\n  }\n  /**\n   * Get an EpubCFI from a Dom Range\n   * @param {Range} range\n   * @param {string} [ignoreClass]\n   * @returns {EpubCFI} cfi\n   */\n\n\n  cfiFromRange(range, ignoreClass) {\n    return new _epubcfi.default(range, this.cfiBase, ignoreClass).toString();\n  }\n  /**\n   * Get an EpubCFI from a Dom node\n   * @param {node} node\n   * @param {string} [ignoreClass]\n   * @returns {EpubCFI} cfi\n   */\n\n\n  cfiFromNode(node, ignoreClass) {\n    return new _epubcfi.default(node, this.cfiBase, ignoreClass).toString();\n  } // TODO: find where this is used - remove?\n\n\n  map(layout) {\n    var map = new _mapping.default(layout);\n    return map.section();\n  }\n  /**\n   * Size the contents to a given width and height\n   * @param {number} [width]\n   * @param {number} [height]\n   */\n\n\n  size(width, height) {\n    var viewport = {\n      scale: 1.0,\n      scalable: \"no\"\n    };\n    this.layoutStyle(\"scrolling\");\n\n    if (width >= 0) {\n      this.width(width);\n      viewport.width = width;\n      this.css(\"padding\", \"0 \" + width / 12 + \"px\");\n    }\n\n    if (height >= 0) {\n      this.height(height);\n      viewport.height = height;\n    }\n\n    this.css(\"margin\", \"0\");\n    this.css(\"box-sizing\", \"border-box\");\n    this.viewport(viewport);\n  }\n  /**\n   * Apply columns to the contents for pagination\n   * @param {number} width\n   * @param {number} height\n   * @param {number} columnWidth\n   * @param {number} gap\n   */\n\n\n  columns(width, height, columnWidth, gap, dir) {\n    let COLUMN_AXIS = (0, _core.prefixed)(\"column-axis\");\n    let COLUMN_GAP = (0, _core.prefixed)(\"column-gap\");\n    let COLUMN_WIDTH = (0, _core.prefixed)(\"column-width\");\n    let COLUMN_FILL = (0, _core.prefixed)(\"column-fill\");\n    let writingMode = this.writingMode();\n    let axis = writingMode.indexOf(\"vertical\") === 0 ? \"vertical\" : \"horizontal\";\n    this.layoutStyle(\"paginated\");\n\n    if (dir === \"rtl\" && axis === \"horizontal\") {\n      this.direction(dir);\n    }\n\n    this.width(width);\n    this.height(height); // Deal with Mobile trying to scale to viewport\n\n    this.viewport({\n      width: width,\n      height: height,\n      scale: 1.0,\n      scalable: \"no\"\n    }); // TODO: inline-block needs more testing\n    // Fixes Safari column cut offs, but causes RTL issues\n    // this.css(\"display\", \"inline-block\");\n\n    this.css(\"overflow-y\", \"hidden\");\n    this.css(\"margin\", \"0\", true);\n\n    if (axis === \"vertical\") {\n      this.css(\"padding-top\", gap / 2 + \"px\", true);\n      this.css(\"padding-bottom\", gap / 2 + \"px\", true);\n      this.css(\"padding-left\", \"20px\");\n      this.css(\"padding-right\", \"20px\");\n      this.css(COLUMN_AXIS, \"vertical\");\n    } else {\n      this.css(\"padding-top\", \"20px\");\n      this.css(\"padding-bottom\", \"20px\");\n      this.css(\"padding-left\", gap / 2 + \"px\", true);\n      this.css(\"padding-right\", gap / 2 + \"px\", true);\n      this.css(COLUMN_AXIS, \"horizontal\");\n    }\n\n    this.css(\"box-sizing\", \"border-box\");\n    this.css(\"max-width\", \"inherit\");\n    this.css(COLUMN_FILL, \"auto\");\n    this.css(COLUMN_GAP, gap + \"px\");\n    this.css(COLUMN_WIDTH, columnWidth + \"px\"); // Fix glyph clipping in WebKit\n    // https://github.com/futurepress/epub.js/issues/983\n\n    this.css(\"-webkit-line-box-contain\", \"block glyphs replaced\");\n  }\n  /**\n   * Scale contents from center\n   * @param {number} scale\n   * @param {number} offsetX\n   * @param {number} offsetY\n   */\n\n\n  scaler(scale, offsetX, offsetY) {\n    var scaleStr = \"scale(\" + scale + \")\";\n    var translateStr = \"\"; // this.css(\"position\", \"absolute\"));\n\n    this.css(\"transform-origin\", \"top left\");\n\n    if (offsetX >= 0 || offsetY >= 0) {\n      translateStr = \" translate(\" + (offsetX || 0) + \"px, \" + (offsetY || 0) + \"px )\";\n    }\n\n    this.css(\"transform\", scaleStr + translateStr);\n  }\n  /**\n   * Fit contents into a fixed width and height\n   * @param {number} width\n   * @param {number} height\n   */\n\n\n  fit(width, height, section) {\n    var viewport = this.viewport();\n    var viewportWidth = parseInt(viewport.width);\n    var viewportHeight = parseInt(viewport.height);\n    var widthScale = width / viewportWidth;\n    var heightScale = height / viewportHeight;\n    var scale = widthScale < heightScale ? widthScale : heightScale; // the translate does not work as intended, elements can end up unaligned\n    // var offsetY = (height - (viewportHeight * scale)) / 2;\n    // var offsetX = 0;\n    // if (this.sectionIndex % 2 === 1) {\n    // \toffsetX = width - (viewportWidth * scale);\n    // }\n\n    this.layoutStyle(\"paginated\"); // scale needs width and height to be set\n\n    this.width(viewportWidth);\n    this.height(viewportHeight);\n    this.overflow(\"hidden\"); // Scale to the correct size\n\n    this.scaler(scale, 0, 0); // this.scaler(scale, offsetX > 0 ? offsetX : 0, offsetY);\n    // background images are not scaled by transform\n\n    this.css(\"background-size\", viewportWidth * scale + \"px \" + viewportHeight * scale + \"px\");\n    this.css(\"background-color\", \"transparent\");\n\n    if (section && section.properties.includes(\"page-spread-left\")) {\n      // set margin since scale is weird\n      var marginLeft = width - viewportWidth * scale;\n      this.css(\"margin-left\", marginLeft + \"px\");\n    }\n  }\n  /**\n   * Set the direction of the text\n   * @param {string} [dir=\"ltr\"] \"rtl\" | \"ltr\"\n   */\n\n\n  direction(dir) {\n    if (this.documentElement) {\n      this.documentElement.style[\"direction\"] = dir;\n    }\n  }\n\n  mapPage(cfiBase, layout, start, end, dev) {\n    var mapping = new _mapping.default(layout, dev);\n    return mapping.page(this, cfiBase, start, end);\n  }\n  /**\n   * Emit event when link in content is clicked\n   * @private\n   */\n\n\n  linksHandler() {\n    (0, _replacements.replaceLinks)(this.content, href => {\n      this.emit(_constants.EVENTS.CONTENTS.LINK_CLICKED, href);\n    });\n  }\n  /**\n   * Set the writingMode of the text\n   * @param {string} [mode=\"horizontal-tb\"] \"horizontal-tb\" | \"vertical-rl\" | \"vertical-lr\"\n   */\n\n\n  writingMode(mode) {\n    let WRITING_MODE = (0, _core.prefixed)(\"writing-mode\");\n\n    if (mode && this.documentElement) {\n      this.documentElement.style[WRITING_MODE] = mode;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[WRITING_MODE] || '';\n  }\n  /**\n   * Set the layoutStyle of the content\n   * @param {string} [style=\"paginated\"] \"scrolling\" | \"paginated\"\n   * @private\n   */\n\n\n  layoutStyle(style) {\n    if (style) {\n      this._layoutStyle = style;\n      navigator.epubReadingSystem.layoutStyle = this._layoutStyle;\n    }\n\n    return this._layoutStyle || \"paginated\";\n  }\n  /**\n   * Add the epubReadingSystem object to the navigator\n   * @param {string} name\n   * @param {string} version\n   * @private\n   */\n\n\n  epubReadingSystem(name, version) {\n    navigator.epubReadingSystem = {\n      name: name,\n      version: version,\n      layoutStyle: this.layoutStyle(),\n      hasFeature: function (feature) {\n        switch (feature) {\n          case \"dom-manipulation\":\n            return true;\n\n          case \"layout-changes\":\n            return true;\n\n          case \"touch-events\":\n            return true;\n\n          case \"mouse-events\":\n            return true;\n\n          case \"keyboard-events\":\n            return true;\n\n          case \"spine-scripting\":\n            return false;\n\n          default:\n            return false;\n        }\n      }\n    };\n    return navigator.epubReadingSystem;\n  }\n\n  destroy() {\n    // this.document.removeEventListener('transitionend', this._resizeCheck);\n    this.removeListeners();\n  }\n\n}\n\n(0, _eventEmitter.default)(Contents.prototype);\nvar _default = Contents;\nexports.default = _default;","map":{"version":3,"sources":["S:/REACT/Ract-Js/Frlnce/node_modules/epubjs/lib/contents.js"],"names":["Object","defineProperty","exports","value","default","_eventEmitter","_interopRequireDefault","require","_core","_epubcfi","_mapping","_replacements","_constants","obj","__esModule","hasNavigator","navigator","isChrome","test","userAgent","isWebkit","ELEMENT_NODE","TEXT_NODE","Contents","constructor","doc","content","cfiBase","sectionIndex","epubcfi","document","documentElement","body","window","defaultView","_size","width","height","epubReadingSystem","EPUBJS_VERSION","called","active","listeners","listenedEvents","DOM_EVENTS","w","frame","isNumber","style","parseInt","getComputedStyle","h","contentWidth","contentHeight","textWidth","rect","range","createRange","border","borders","selectNodeContents","getBoundingClientRect","Math","round","textHeight","bottom","scrollWidth","scrollHeight","overflow","overflowX","overflowY","css","property","priority","setProperty","removeProperty","viewport","options","_width","_height","_scale","_minimum","_maximum","_scalable","$viewport","querySelector","parsed","undefined","newContent","settings","hasAttribute","getAttribute","match","length","scale","minimum","maximum","scalable","defaults","push","createElement","setAttribute","appendChild","join","scrollTo","expand","emit","EVENTS","CONTENTS","EXPAND","imageLoadListeners","mediaQueryListeners","addEventListeners","addSelectionListeners","ResizeObserver","resizeListeners","visibilityListeners","resizeObservers","linksHandler","removeListeners","removeEventListeners","removeSelectionListeners","observer","disconnect","clearTimeout","expanding","resizeCheck","onResize","RESIZE","requestAnimationFrame","bind","setTimeout","addEventListener","visibilityState","transitionListeners","_resizeCheck","sheets","styleSheets","mediaChangeHandler","m","matches","_expanding","i","rules","cssRules","e","j","media","mql","matchMedia","mediaText","addListener","observe","mutationObservers","MutationObserver","mutations","config","attributes","childList","characterData","subtree","images","querySelectorAll","img","naturalWidth","onload","fontLoadListeners","fonts","ready","then","root","locationOf","target","ignoreClass","position","targetPos","isCfiString","toRange","endContainer","startContainer","startOffset","endOffset","pos","textContent","indexOf","setEnd","console","error","nodeType","Node","left","top","container","newRange","Range","setStart","parentNode","stack","id","substring","el","getElementById","selectNode","addStylesheet","src","Promise","resolve","reject","$stylesheet","type","rel","href","onreadystatechange","readyState","head","_getStylesheetNode","key","styleEl","addStylesheetCss","serializedCss","innerHTML","addStylesheetRules","styleSheet","sheet","prototype","toString","call","rl","rule","selector","propStr","pl","prop","insertRule","selectors","keys","forEach","definition","Array","isArray","item","_rules","result","map","addScript","$script","async","addClass","className","classList","add","removeClass","remove","_triggerEvent","triggerEvent","eventName","passive","removeEventListener","_onSelectionChange","onSelectionChange","selectionEndTimeout","selection","getSelection","triggerSelectedEvent","cfirange","rangeCount","getRangeAt","collapsed","SELECTED","SELECTED_RANGE","_cfi","cfi","cfiFromRange","cfiFromNode","node","layout","section","size","layoutStyle","columns","columnWidth","gap","dir","COLUMN_AXIS","prefixed","COLUMN_GAP","COLUMN_WIDTH","COLUMN_FILL","writingMode","axis","direction","scaler","offsetX","offsetY","scaleStr","translateStr","fit","viewportWidth","viewportHeight","widthScale","heightScale","properties","includes","marginLeft","mapPage","start","end","dev","mapping","page","replaceLinks","LINK_CLICKED","mode","WRITING_MODE","_layoutStyle","name","version","hasFeature","feature","destroy","_default"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _eventEmitter = _interopRequireDefault(require(\"event-emitter\"));\n\nvar _core = require(\"./utils/core\");\n\nvar _epubcfi = _interopRequireDefault(require(\"./epubcfi\"));\n\nvar _mapping = _interopRequireDefault(require(\"./mapping\"));\n\nvar _replacements = require(\"./utils/replacements\");\n\nvar _constants = require(\"./utils/constants\");\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nconst hasNavigator = typeof navigator !== \"undefined\";\nconst isChrome = hasNavigator && /Chrome/.test(navigator.userAgent);\nconst isWebkit = hasNavigator && !isChrome && /AppleWebKit/.test(navigator.userAgent);\nconst ELEMENT_NODE = 1;\nconst TEXT_NODE = 3;\n/**\n\t* Handles DOM manipulation, queries and events for View contents\n\t* @class\n\t* @param {document} doc Document\n\t* @param {element} content Parent Element (typically Body)\n\t* @param {string} cfiBase Section component of CFIs\n\t* @param {number} sectionIndex Index in Spine of Conntent's Section\n\t*/\n\nclass Contents {\n  constructor(doc, content, cfiBase, sectionIndex) {\n    // Blank Cfi for Parsing\n    this.epubcfi = new _epubcfi.default();\n    this.document = doc;\n    this.documentElement = this.document.documentElement;\n    this.content = content || this.document.body;\n    this.window = this.document.defaultView;\n    this._size = {\n      width: 0,\n      height: 0\n    };\n    this.sectionIndex = sectionIndex || 0;\n    this.cfiBase = cfiBase || \"\";\n    this.epubReadingSystem(\"epub.js\", _constants.EPUBJS_VERSION);\n    this.called = 0;\n    this.active = true;\n    this.listeners();\n  }\n  /**\n  \t* Get DOM events that are listened for and passed along\n  \t*/\n\n\n  static get listenedEvents() {\n    return _constants.DOM_EVENTS;\n  }\n  /**\n  \t* Get or Set width\n  \t* @param {number} [w]\n  \t* @returns {number} width\n  \t*/\n\n\n  width(w) {\n    // var frame = this.documentElement;\n    var frame = this.content;\n\n    if (w && (0, _core.isNumber)(w)) {\n      w = w + \"px\";\n    }\n\n    if (w) {\n      frame.style.width = w; // this.content.style.width = w;\n    }\n\n    return parseInt(this.window.getComputedStyle(frame)[\"width\"]);\n  }\n  /**\n  \t* Get or Set height\n  \t* @param {number} [h]\n  \t* @returns {number} height\n  \t*/\n\n\n  height(h) {\n    // var frame = this.documentElement;\n    var frame = this.content;\n\n    if (h && (0, _core.isNumber)(h)) {\n      h = h + \"px\";\n    }\n\n    if (h) {\n      frame.style.height = h; // this.content.style.height = h;\n    }\n\n    return parseInt(this.window.getComputedStyle(frame)[\"height\"]);\n  }\n  /**\n  \t* Get or Set width of the contents\n  \t* @param {number} [w]\n  \t* @returns {number} width\n  \t*/\n\n\n  contentWidth(w) {\n    var content = this.content || this.document.body;\n\n    if (w && (0, _core.isNumber)(w)) {\n      w = w + \"px\";\n    }\n\n    if (w) {\n      content.style.width = w;\n    }\n\n    return parseInt(this.window.getComputedStyle(content)[\"width\"]);\n  }\n  /**\n  \t* Get or Set height of the contents\n  \t* @param {number} [h]\n  \t* @returns {number} height\n  \t*/\n\n\n  contentHeight(h) {\n    var content = this.content || this.document.body;\n\n    if (h && (0, _core.isNumber)(h)) {\n      h = h + \"px\";\n    }\n\n    if (h) {\n      content.style.height = h;\n    }\n\n    return parseInt(this.window.getComputedStyle(content)[\"height\"]);\n  }\n  /**\n  \t* Get the width of the text using Range\n  \t* @returns {number} width\n  \t*/\n\n\n  textWidth() {\n    let rect;\n    let width;\n    let range = this.document.createRange();\n    let content = this.content || this.document.body;\n    let border = (0, _core.borders)(content); // Select the contents of frame\n\n    range.selectNodeContents(content); // get the width of the text content\n\n    rect = range.getBoundingClientRect();\n    width = rect.width;\n\n    if (border && border.width) {\n      width += border.width;\n    }\n\n    return Math.round(width);\n  }\n  /**\n  \t* Get the height of the text using Range\n  \t* @returns {number} height\n  \t*/\n\n\n  textHeight() {\n    let rect;\n    let height;\n    let range = this.document.createRange();\n    let content = this.content || this.document.body;\n    range.selectNodeContents(content);\n    rect = range.getBoundingClientRect();\n    height = rect.bottom;\n    return Math.round(height);\n  }\n  /**\n  \t* Get documentElement scrollWidth\n  \t* @returns {number} width\n  \t*/\n\n\n  scrollWidth() {\n    var width = this.documentElement.scrollWidth;\n    return width;\n  }\n  /**\n  \t* Get documentElement scrollHeight\n  \t* @returns {number} height\n  \t*/\n\n\n  scrollHeight() {\n    var height = this.documentElement.scrollHeight;\n    return height;\n  }\n  /**\n  \t* Set overflow css style of the contents\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflow(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflow = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflow\"];\n  }\n  /**\n  \t* Set overflowX css style of the documentElement\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflowX(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflowX = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflowX\"];\n  }\n  /**\n  \t* Set overflowY css style of the documentElement\n  \t* @param {string} [overflow]\n  \t*/\n\n\n  overflowY(overflow) {\n    if (overflow) {\n      this.documentElement.style.overflowY = overflow;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[\"overflowY\"];\n  }\n  /**\n  \t* Set Css styles on the contents element (typically Body)\n  \t* @param {string} property\n  \t* @param {string} value\n  \t* @param {boolean} [priority] set as \"important\"\n  \t*/\n\n\n  css(property, value, priority) {\n    var content = this.content || this.document.body;\n\n    if (value) {\n      content.style.setProperty(property, value, priority ? \"important\" : \"\");\n    } else {\n      content.style.removeProperty(property);\n    }\n\n    return this.window.getComputedStyle(content)[property];\n  }\n  /**\n  \t* Get or Set the viewport element\n  \t* @param {object} [options]\n  \t* @param {string} [options.width]\n  \t* @param {string} [options.height]\n  \t* @param {string} [options.scale]\n  \t* @param {string} [options.minimum]\n  \t* @param {string} [options.maximum]\n  \t* @param {string} [options.scalable]\n  \t*/\n\n\n  viewport(options) {\n    var _width, _height, _scale, _minimum, _maximum, _scalable; // var width, height, scale, minimum, maximum, scalable;\n\n\n    var $viewport = this.document.querySelector(\"meta[name='viewport']\");\n    var parsed = {\n      \"width\": undefined,\n      \"height\": undefined,\n      \"scale\": undefined,\n      \"minimum\": undefined,\n      \"maximum\": undefined,\n      \"scalable\": undefined\n    };\n    var newContent = [];\n    var settings = {};\n    /*\n    * check for the viewport size\n    * <meta name=\"viewport\" content=\"width=1024,height=697\" />\n    */\n\n    if ($viewport && $viewport.hasAttribute(\"content\")) {\n      let content = $viewport.getAttribute(\"content\");\n\n      let _width = content.match(/width\\s*=\\s*([^,]*)/);\n\n      let _height = content.match(/height\\s*=\\s*([^,]*)/);\n\n      let _scale = content.match(/initial-scale\\s*=\\s*([^,]*)/);\n\n      let _minimum = content.match(/minimum-scale\\s*=\\s*([^,]*)/);\n\n      let _maximum = content.match(/maximum-scale\\s*=\\s*([^,]*)/);\n\n      let _scalable = content.match(/user-scalable\\s*=\\s*([^,]*)/);\n\n      if (_width && _width.length && typeof _width[1] !== \"undefined\") {\n        parsed.width = _width[1];\n      }\n\n      if (_height && _height.length && typeof _height[1] !== \"undefined\") {\n        parsed.height = _height[1];\n      }\n\n      if (_scale && _scale.length && typeof _scale[1] !== \"undefined\") {\n        parsed.scale = _scale[1];\n      }\n\n      if (_minimum && _minimum.length && typeof _minimum[1] !== \"undefined\") {\n        parsed.minimum = _minimum[1];\n      }\n\n      if (_maximum && _maximum.length && typeof _maximum[1] !== \"undefined\") {\n        parsed.maximum = _maximum[1];\n      }\n\n      if (_scalable && _scalable.length && typeof _scalable[1] !== \"undefined\") {\n        parsed.scalable = _scalable[1];\n      }\n    }\n\n    settings = (0, _core.defaults)(options || {}, parsed);\n\n    if (options) {\n      if (settings.width) {\n        newContent.push(\"width=\" + settings.width);\n      }\n\n      if (settings.height) {\n        newContent.push(\"height=\" + settings.height);\n      }\n\n      if (settings.scale) {\n        newContent.push(\"initial-scale=\" + settings.scale);\n      }\n\n      if (settings.scalable === \"no\") {\n        newContent.push(\"minimum-scale=\" + settings.scale);\n        newContent.push(\"maximum-scale=\" + settings.scale);\n        newContent.push(\"user-scalable=\" + settings.scalable);\n      } else {\n        if (settings.scalable) {\n          newContent.push(\"user-scalable=\" + settings.scalable);\n        }\n\n        if (settings.minimum) {\n          newContent.push(\"minimum-scale=\" + settings.minimum);\n        }\n\n        if (settings.maximum) {\n          newContent.push(\"minimum-scale=\" + settings.maximum);\n        }\n      }\n\n      if (!$viewport) {\n        $viewport = this.document.createElement(\"meta\");\n        $viewport.setAttribute(\"name\", \"viewport\");\n        this.document.querySelector(\"head\").appendChild($viewport);\n      }\n\n      $viewport.setAttribute(\"content\", newContent.join(\", \"));\n      this.window.scrollTo(0, 0);\n    }\n\n    return settings;\n  }\n  /**\n   * Event emitter for when the contents has expanded\n   * @private\n   */\n\n\n  expand() {\n    this.emit(_constants.EVENTS.CONTENTS.EXPAND);\n  }\n  /**\n   * Add DOM listeners\n   * @private\n   */\n\n\n  listeners() {\n    this.imageLoadListeners();\n    this.mediaQueryListeners(); // this.fontLoadListeners();\n\n    this.addEventListeners();\n    this.addSelectionListeners(); // this.transitionListeners();\n\n    if (typeof ResizeObserver === \"undefined\") {\n      this.resizeListeners();\n      this.visibilityListeners();\n    } else {\n      this.resizeObservers();\n    } // this.mutationObservers();\n\n\n    this.linksHandler();\n  }\n  /**\n   * Remove DOM listeners\n   * @private\n   */\n\n\n  removeListeners() {\n    this.removeEventListeners();\n    this.removeSelectionListeners();\n\n    if (this.observer) {\n      this.observer.disconnect();\n    }\n\n    clearTimeout(this.expanding);\n  }\n  /**\n   * Check if size of contents has changed and\n   * emit 'resize' event if it has.\n   * @private\n   */\n\n\n  resizeCheck() {\n    let width = this.textWidth();\n    let height = this.textHeight();\n\n    if (width != this._size.width || height != this._size.height) {\n      this._size = {\n        width: width,\n        height: height\n      };\n      this.onResize && this.onResize(this._size);\n      this.emit(_constants.EVENTS.CONTENTS.RESIZE, this._size);\n    }\n  }\n  /**\n   * Poll for resize detection\n   * @private\n   */\n\n\n  resizeListeners() {\n    var width, height; // Test size again\n\n    clearTimeout(this.expanding);\n    requestAnimationFrame(this.resizeCheck.bind(this));\n    this.expanding = setTimeout(this.resizeListeners.bind(this), 350);\n  }\n  /**\n   * Listen for visibility of tab to change\n   * @private\n   */\n\n\n  visibilityListeners() {\n    document.addEventListener(\"visibilitychange\", () => {\n      if (document.visibilityState === \"visible\" && this.active === false) {\n        this.active = true;\n        this.resizeListeners();\n      } else {\n        this.active = false;\n        clearTimeout(this.expanding);\n      }\n    });\n  }\n  /**\n   * Use css transitions to detect resize\n   * @private\n   */\n\n\n  transitionListeners() {\n    let body = this.content;\n    body.style['transitionProperty'] = \"font, font-size, font-size-adjust, font-stretch, font-variation-settings, font-weight, width, height\";\n    body.style['transitionDuration'] = \"0.001ms\";\n    body.style['transitionTimingFunction'] = \"linear\";\n    body.style['transitionDelay'] = \"0\";\n    this._resizeCheck = this.resizeCheck.bind(this);\n    this.document.addEventListener('transitionend', this._resizeCheck);\n  }\n  /**\n   * Listen for media query changes and emit 'expand' event\n   * Adapted from: https://github.com/tylergaw/media-query-events/blob/master/js/mq-events.js\n   * @private\n   */\n\n\n  mediaQueryListeners() {\n    var sheets = this.document.styleSheets;\n\n    var mediaChangeHandler = function (m) {\n      if (m.matches && !this._expanding) {\n        setTimeout(this.expand.bind(this), 1);\n      }\n    }.bind(this);\n\n    for (var i = 0; i < sheets.length; i += 1) {\n      var rules; // Firefox errors if we access cssRules cross-domain\n\n      try {\n        rules = sheets[i].cssRules;\n      } catch (e) {\n        return;\n      }\n\n      if (!rules) return; // Stylesheets changed\n\n      for (var j = 0; j < rules.length; j += 1) {\n        //if (rules[j].constructor === CSSMediaRule) {\n        if (rules[j].media) {\n          var mql = this.window.matchMedia(rules[j].media.mediaText);\n          mql.addListener(mediaChangeHandler); //mql.onchange = mediaChangeHandler;\n        }\n      }\n    }\n  }\n  /**\n   * Use ResizeObserver to listen for changes in the DOM and check for resize\n   * @private\n   */\n\n\n  resizeObservers() {\n    // create an observer instance\n    this.observer = new ResizeObserver(e => {\n      requestAnimationFrame(this.resizeCheck.bind(this));\n    }); // pass in the target node\n\n    this.observer.observe(this.document.documentElement);\n  }\n  /**\n   * Use MutationObserver to listen for changes in the DOM and check for resize\n   * @private\n   */\n\n\n  mutationObservers() {\n    // create an observer instance\n    this.observer = new MutationObserver(mutations => {\n      this.resizeCheck();\n    }); // configuration of the observer:\n\n    let config = {\n      attributes: true,\n      childList: true,\n      characterData: true,\n      subtree: true\n    }; // pass in the target node, as well as the observer options\n\n    this.observer.observe(this.document, config);\n  }\n  /**\n   * Test if images are loaded or add listener for when they load\n   * @private\n   */\n\n\n  imageLoadListeners() {\n    var images = this.document.querySelectorAll(\"img\");\n    var img;\n\n    for (var i = 0; i < images.length; i++) {\n      img = images[i];\n\n      if (typeof img.naturalWidth !== \"undefined\" && img.naturalWidth === 0) {\n        img.onload = this.expand.bind(this);\n      }\n    }\n  }\n  /**\n   * Listen for font load and check for resize when loaded\n   * @private\n   */\n\n\n  fontLoadListeners() {\n    if (!this.document || !this.document.fonts) {\n      return;\n    }\n\n    this.document.fonts.ready.then(function () {\n      this.resizeCheck();\n    }.bind(this));\n  }\n  /**\n   * Get the documentElement\n   * @returns {element} documentElement\n   */\n\n\n  root() {\n    if (!this.document) return null;\n    return this.document.documentElement;\n  }\n  /**\n   * Get the location offset of a EpubCFI or an #id\n   * @param {string | EpubCFI} target\n   * @param {string} [ignoreClass] for the cfi\n   * @returns { {left: Number, top: Number }\n   */\n\n\n  locationOf(target, ignoreClass) {\n    var position;\n    var targetPos = {\n      \"left\": 0,\n      \"top\": 0\n    };\n    if (!this.document) return targetPos;\n\n    if (this.epubcfi.isCfiString(target)) {\n      let range = new _epubcfi.default(target).toRange(this.document, ignoreClass);\n\n      if (range) {\n        try {\n          if (!range.endContainer || range.startContainer == range.endContainer && range.startOffset == range.endOffset) {\n            // If the end for the range is not set, it results in collapsed becoming\n            // true. This in turn leads to inconsistent behaviour when calling\n            // getBoundingRect. Wrong bounds lead to the wrong page being displayed.\n            // https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/15684911/\n            let pos = range.startContainer.textContent.indexOf(\" \", range.startOffset);\n\n            if (pos == -1) {\n              pos = range.startContainer.textContent.length;\n            }\n\n            range.setEnd(range.startContainer, pos);\n          }\n        } catch (e) {\n          console.error(\"setting end offset to start container length failed\", e);\n        }\n\n        if (range.startContainer.nodeType === Node.ELEMENT_NODE) {\n          position = range.startContainer.getBoundingClientRect();\n          targetPos.left = position.left;\n          targetPos.top = position.top;\n        } else {\n          // Webkit does not handle collapsed range bounds correctly\n          // https://bugs.webkit.org/show_bug.cgi?id=138949\n          // Construct a new non-collapsed range\n          if (isWebkit) {\n            let container = range.startContainer;\n            let newRange = new Range();\n\n            try {\n              if (container.nodeType === ELEMENT_NODE) {\n                position = container.getBoundingClientRect();\n              } else if (range.startOffset + 2 < container.length) {\n                newRange.setStart(container, range.startOffset);\n                newRange.setEnd(container, range.startOffset + 2);\n                position = newRange.getBoundingClientRect();\n              } else if (range.startOffset - 2 > 0) {\n                newRange.setStart(container, range.startOffset - 2);\n                newRange.setEnd(container, range.startOffset);\n                position = newRange.getBoundingClientRect();\n              } else {\n                // empty, return the parent element\n                position = container.parentNode.getBoundingClientRect();\n              }\n            } catch (e) {\n              console.error(e, e.stack);\n            }\n          } else {\n            position = range.getBoundingClientRect();\n          }\n        }\n      }\n    } else if (typeof target === \"string\" && target.indexOf(\"#\") > -1) {\n      let id = target.substring(target.indexOf(\"#\") + 1);\n      let el = this.document.getElementById(id);\n\n      if (el) {\n        if (isWebkit) {\n          // Webkit reports incorrect bounding rects in Columns\n          let newRange = new Range();\n          newRange.selectNode(el);\n          position = newRange.getBoundingClientRect();\n        } else {\n          position = el.getBoundingClientRect();\n        }\n      }\n    }\n\n    if (position) {\n      targetPos.left = position.left;\n      targetPos.top = position.top;\n    }\n\n    return targetPos;\n  }\n  /**\n   * Append a stylesheet link to the document head\n   * @param {string} src url\n   */\n\n\n  addStylesheet(src) {\n    return new Promise(function (resolve, reject) {\n      var $stylesheet;\n      var ready = false;\n\n      if (!this.document) {\n        resolve(false);\n        return;\n      } // Check if link already exists\n\n\n      $stylesheet = this.document.querySelector(\"link[href='\" + src + \"']\");\n\n      if ($stylesheet) {\n        resolve(true);\n        return; // already present\n      }\n\n      $stylesheet = this.document.createElement(\"link\");\n      $stylesheet.type = \"text/css\";\n      $stylesheet.rel = \"stylesheet\";\n      $stylesheet.href = src;\n\n      $stylesheet.onload = $stylesheet.onreadystatechange = function () {\n        if (!ready && (!this.readyState || this.readyState == \"complete\")) {\n          ready = true; // Let apply\n\n          setTimeout(() => {\n            resolve(true);\n          }, 1);\n        }\n      };\n\n      this.document.head.appendChild($stylesheet);\n    }.bind(this));\n  }\n\n  _getStylesheetNode(key) {\n    var styleEl;\n    key = \"epubjs-inserted-css-\" + (key || '');\n    if (!this.document) return false; // Check if link already exists\n\n    styleEl = this.document.getElementById(key);\n\n    if (!styleEl) {\n      styleEl = this.document.createElement(\"style\");\n      styleEl.id = key; // Append style element to head\n\n      this.document.head.appendChild(styleEl);\n    }\n\n    return styleEl;\n  }\n  /**\n   * Append stylesheet css\n   * @param {string} serializedCss\n   * @param {string} key If the key is the same, the CSS will be replaced instead of inserted\n   */\n\n\n  addStylesheetCss(serializedCss, key) {\n    if (!this.document || !serializedCss) return false;\n    var styleEl;\n    styleEl = this._getStylesheetNode(key);\n    styleEl.innerHTML = serializedCss;\n    return true;\n  }\n  /**\n   * Append stylesheet rules to a generate stylesheet\n   * Array: https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule\n   * Object: https://github.com/desirable-objects/json-to-css\n   * @param {array | object} rules\n   * @param {string} key If the key is the same, the CSS will be replaced instead of inserted\n   */\n\n\n  addStylesheetRules(rules, key) {\n    var styleSheet;\n    if (!this.document || !rules || rules.length === 0) return; // Grab style sheet\n\n    styleSheet = this._getStylesheetNode(key).sheet;\n\n    if (Object.prototype.toString.call(rules) === \"[object Array]\") {\n      for (var i = 0, rl = rules.length; i < rl; i++) {\n        var j = 1,\n            rule = rules[i],\n            selector = rules[i][0],\n            propStr = \"\"; // If the second argument of a rule is an array of arrays, correct our variables.\n\n        if (Object.prototype.toString.call(rule[1][0]) === \"[object Array]\") {\n          rule = rule[1];\n          j = 0;\n        }\n\n        for (var pl = rule.length; j < pl; j++) {\n          var prop = rule[j];\n          propStr += prop[0] + \":\" + prop[1] + (prop[2] ? \" !important\" : \"\") + \";\\n\";\n        } // Insert CSS Rule\n\n\n        styleSheet.insertRule(selector + \"{\" + propStr + \"}\", styleSheet.cssRules.length);\n      }\n    } else {\n      const selectors = Object.keys(rules);\n      selectors.forEach(selector => {\n        const definition = rules[selector];\n\n        if (Array.isArray(definition)) {\n          definition.forEach(item => {\n            const _rules = Object.keys(item);\n\n            const result = _rules.map(rule => {\n              return `${rule}:${item[rule]}`;\n            }).join(';');\n\n            styleSheet.insertRule(`${selector}{${result}}`, styleSheet.cssRules.length);\n          });\n        } else {\n          const _rules = Object.keys(definition);\n\n          const result = _rules.map(rule => {\n            return `${rule}:${definition[rule]}`;\n          }).join(';');\n\n          styleSheet.insertRule(`${selector}{${result}}`, styleSheet.cssRules.length);\n        }\n      });\n    }\n  }\n  /**\n   * Append a script tag to the document head\n   * @param {string} src url\n   * @returns {Promise} loaded\n   */\n\n\n  addScript(src) {\n    return new Promise(function (resolve, reject) {\n      var $script;\n      var ready = false;\n\n      if (!this.document) {\n        resolve(false);\n        return;\n      }\n\n      $script = this.document.createElement(\"script\");\n      $script.type = \"text/javascript\";\n      $script.async = true;\n      $script.src = src;\n\n      $script.onload = $script.onreadystatechange = function () {\n        if (!ready && (!this.readyState || this.readyState == \"complete\")) {\n          ready = true;\n          setTimeout(function () {\n            resolve(true);\n          }, 1);\n        }\n      };\n\n      this.document.head.appendChild($script);\n    }.bind(this));\n  }\n  /**\n   * Add a class to the contents container\n   * @param {string} className\n   */\n\n\n  addClass(className) {\n    var content;\n    if (!this.document) return;\n    content = this.content || this.document.body;\n\n    if (content) {\n      content.classList.add(className);\n    }\n  }\n  /**\n   * Remove a class from the contents container\n   * @param {string} removeClass\n   */\n\n\n  removeClass(className) {\n    var content;\n    if (!this.document) return;\n    content = this.content || this.document.body;\n\n    if (content) {\n      content.classList.remove(className);\n    }\n  }\n  /**\n   * Add DOM event listeners\n   * @private\n   */\n\n\n  addEventListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this._triggerEvent = this.triggerEvent.bind(this);\n\n    _constants.DOM_EVENTS.forEach(function (eventName) {\n      this.document.addEventListener(eventName, this._triggerEvent, {\n        passive: true\n      });\n    }, this);\n  }\n  /**\n   * Remove DOM event listeners\n   * @private\n   */\n\n\n  removeEventListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    _constants.DOM_EVENTS.forEach(function (eventName) {\n      this.document.removeEventListener(eventName, this._triggerEvent, {\n        passive: true\n      });\n    }, this);\n\n    this._triggerEvent = undefined;\n  }\n  /**\n   * Emit passed browser events\n   * @private\n   */\n\n\n  triggerEvent(e) {\n    this.emit(e.type, e);\n  }\n  /**\n   * Add listener for text selection\n   * @private\n   */\n\n\n  addSelectionListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this._onSelectionChange = this.onSelectionChange.bind(this);\n    this.document.addEventListener(\"selectionchange\", this._onSelectionChange, {\n      passive: true\n    });\n  }\n  /**\n   * Remove listener for text selection\n   * @private\n   */\n\n\n  removeSelectionListeners() {\n    if (!this.document) {\n      return;\n    }\n\n    this.document.removeEventListener(\"selectionchange\", this._onSelectionChange, {\n      passive: true\n    });\n    this._onSelectionChange = undefined;\n  }\n  /**\n   * Handle getting text on selection\n   * @private\n   */\n\n\n  onSelectionChange(e) {\n    if (this.selectionEndTimeout) {\n      clearTimeout(this.selectionEndTimeout);\n    }\n\n    this.selectionEndTimeout = setTimeout(function () {\n      var selection = this.window.getSelection();\n      this.triggerSelectedEvent(selection);\n    }.bind(this), 250);\n  }\n  /**\n   * Emit event on text selection\n   * @private\n   */\n\n\n  triggerSelectedEvent(selection) {\n    var range, cfirange;\n\n    if (selection && selection.rangeCount > 0) {\n      range = selection.getRangeAt(0);\n\n      if (!range.collapsed) {\n        // cfirange = this.section.cfiFromRange(range);\n        cfirange = new _epubcfi.default(range, this.cfiBase).toString();\n        this.emit(_constants.EVENTS.CONTENTS.SELECTED, cfirange);\n        this.emit(_constants.EVENTS.CONTENTS.SELECTED_RANGE, range);\n      }\n    }\n  }\n  /**\n   * Get a Dom Range from EpubCFI\n   * @param {EpubCFI} _cfi\n   * @param {string} [ignoreClass]\n   * @returns {Range} range\n   */\n\n\n  range(_cfi, ignoreClass) {\n    var cfi = new _epubcfi.default(_cfi);\n    return cfi.toRange(this.document, ignoreClass);\n  }\n  /**\n   * Get an EpubCFI from a Dom Range\n   * @param {Range} range\n   * @param {string} [ignoreClass]\n   * @returns {EpubCFI} cfi\n   */\n\n\n  cfiFromRange(range, ignoreClass) {\n    return new _epubcfi.default(range, this.cfiBase, ignoreClass).toString();\n  }\n  /**\n   * Get an EpubCFI from a Dom node\n   * @param {node} node\n   * @param {string} [ignoreClass]\n   * @returns {EpubCFI} cfi\n   */\n\n\n  cfiFromNode(node, ignoreClass) {\n    return new _epubcfi.default(node, this.cfiBase, ignoreClass).toString();\n  } // TODO: find where this is used - remove?\n\n\n  map(layout) {\n    var map = new _mapping.default(layout);\n    return map.section();\n  }\n  /**\n   * Size the contents to a given width and height\n   * @param {number} [width]\n   * @param {number} [height]\n   */\n\n\n  size(width, height) {\n    var viewport = {\n      scale: 1.0,\n      scalable: \"no\"\n    };\n    this.layoutStyle(\"scrolling\");\n\n    if (width >= 0) {\n      this.width(width);\n      viewport.width = width;\n      this.css(\"padding\", \"0 \" + width / 12 + \"px\");\n    }\n\n    if (height >= 0) {\n      this.height(height);\n      viewport.height = height;\n    }\n\n    this.css(\"margin\", \"0\");\n    this.css(\"box-sizing\", \"border-box\");\n    this.viewport(viewport);\n  }\n  /**\n   * Apply columns to the contents for pagination\n   * @param {number} width\n   * @param {number} height\n   * @param {number} columnWidth\n   * @param {number} gap\n   */\n\n\n  columns(width, height, columnWidth, gap, dir) {\n    let COLUMN_AXIS = (0, _core.prefixed)(\"column-axis\");\n    let COLUMN_GAP = (0, _core.prefixed)(\"column-gap\");\n    let COLUMN_WIDTH = (0, _core.prefixed)(\"column-width\");\n    let COLUMN_FILL = (0, _core.prefixed)(\"column-fill\");\n    let writingMode = this.writingMode();\n    let axis = writingMode.indexOf(\"vertical\") === 0 ? \"vertical\" : \"horizontal\";\n    this.layoutStyle(\"paginated\");\n\n    if (dir === \"rtl\" && axis === \"horizontal\") {\n      this.direction(dir);\n    }\n\n    this.width(width);\n    this.height(height); // Deal with Mobile trying to scale to viewport\n\n    this.viewport({\n      width: width,\n      height: height,\n      scale: 1.0,\n      scalable: \"no\"\n    }); // TODO: inline-block needs more testing\n    // Fixes Safari column cut offs, but causes RTL issues\n    // this.css(\"display\", \"inline-block\");\n\n    this.css(\"overflow-y\", \"hidden\");\n    this.css(\"margin\", \"0\", true);\n\n    if (axis === \"vertical\") {\n      this.css(\"padding-top\", gap / 2 + \"px\", true);\n      this.css(\"padding-bottom\", gap / 2 + \"px\", true);\n      this.css(\"padding-left\", \"20px\");\n      this.css(\"padding-right\", \"20px\");\n      this.css(COLUMN_AXIS, \"vertical\");\n    } else {\n      this.css(\"padding-top\", \"20px\");\n      this.css(\"padding-bottom\", \"20px\");\n      this.css(\"padding-left\", gap / 2 + \"px\", true);\n      this.css(\"padding-right\", gap / 2 + \"px\", true);\n      this.css(COLUMN_AXIS, \"horizontal\");\n    }\n\n    this.css(\"box-sizing\", \"border-box\");\n    this.css(\"max-width\", \"inherit\");\n    this.css(COLUMN_FILL, \"auto\");\n    this.css(COLUMN_GAP, gap + \"px\");\n    this.css(COLUMN_WIDTH, columnWidth + \"px\"); // Fix glyph clipping in WebKit\n    // https://github.com/futurepress/epub.js/issues/983\n\n    this.css(\"-webkit-line-box-contain\", \"block glyphs replaced\");\n  }\n  /**\n   * Scale contents from center\n   * @param {number} scale\n   * @param {number} offsetX\n   * @param {number} offsetY\n   */\n\n\n  scaler(scale, offsetX, offsetY) {\n    var scaleStr = \"scale(\" + scale + \")\";\n    var translateStr = \"\"; // this.css(\"position\", \"absolute\"));\n\n    this.css(\"transform-origin\", \"top left\");\n\n    if (offsetX >= 0 || offsetY >= 0) {\n      translateStr = \" translate(\" + (offsetX || 0) + \"px, \" + (offsetY || 0) + \"px )\";\n    }\n\n    this.css(\"transform\", scaleStr + translateStr);\n  }\n  /**\n   * Fit contents into a fixed width and height\n   * @param {number} width\n   * @param {number} height\n   */\n\n\n  fit(width, height, section) {\n    var viewport = this.viewport();\n    var viewportWidth = parseInt(viewport.width);\n    var viewportHeight = parseInt(viewport.height);\n    var widthScale = width / viewportWidth;\n    var heightScale = height / viewportHeight;\n    var scale = widthScale < heightScale ? widthScale : heightScale; // the translate does not work as intended, elements can end up unaligned\n    // var offsetY = (height - (viewportHeight * scale)) / 2;\n    // var offsetX = 0;\n    // if (this.sectionIndex % 2 === 1) {\n    // \toffsetX = width - (viewportWidth * scale);\n    // }\n\n    this.layoutStyle(\"paginated\"); // scale needs width and height to be set\n\n    this.width(viewportWidth);\n    this.height(viewportHeight);\n    this.overflow(\"hidden\"); // Scale to the correct size\n\n    this.scaler(scale, 0, 0); // this.scaler(scale, offsetX > 0 ? offsetX : 0, offsetY);\n    // background images are not scaled by transform\n\n    this.css(\"background-size\", viewportWidth * scale + \"px \" + viewportHeight * scale + \"px\");\n    this.css(\"background-color\", \"transparent\");\n\n    if (section && section.properties.includes(\"page-spread-left\")) {\n      // set margin since scale is weird\n      var marginLeft = width - viewportWidth * scale;\n      this.css(\"margin-left\", marginLeft + \"px\");\n    }\n  }\n  /**\n   * Set the direction of the text\n   * @param {string} [dir=\"ltr\"] \"rtl\" | \"ltr\"\n   */\n\n\n  direction(dir) {\n    if (this.documentElement) {\n      this.documentElement.style[\"direction\"] = dir;\n    }\n  }\n\n  mapPage(cfiBase, layout, start, end, dev) {\n    var mapping = new _mapping.default(layout, dev);\n    return mapping.page(this, cfiBase, start, end);\n  }\n  /**\n   * Emit event when link in content is clicked\n   * @private\n   */\n\n\n  linksHandler() {\n    (0, _replacements.replaceLinks)(this.content, href => {\n      this.emit(_constants.EVENTS.CONTENTS.LINK_CLICKED, href);\n    });\n  }\n  /**\n   * Set the writingMode of the text\n   * @param {string} [mode=\"horizontal-tb\"] \"horizontal-tb\" | \"vertical-rl\" | \"vertical-lr\"\n   */\n\n\n  writingMode(mode) {\n    let WRITING_MODE = (0, _core.prefixed)(\"writing-mode\");\n\n    if (mode && this.documentElement) {\n      this.documentElement.style[WRITING_MODE] = mode;\n    }\n\n    return this.window.getComputedStyle(this.documentElement)[WRITING_MODE] || '';\n  }\n  /**\n   * Set the layoutStyle of the content\n   * @param {string} [style=\"paginated\"] \"scrolling\" | \"paginated\"\n   * @private\n   */\n\n\n  layoutStyle(style) {\n    if (style) {\n      this._layoutStyle = style;\n      navigator.epubReadingSystem.layoutStyle = this._layoutStyle;\n    }\n\n    return this._layoutStyle || \"paginated\";\n  }\n  /**\n   * Add the epubReadingSystem object to the navigator\n   * @param {string} name\n   * @param {string} version\n   * @private\n   */\n\n\n  epubReadingSystem(name, version) {\n    navigator.epubReadingSystem = {\n      name: name,\n      version: version,\n      layoutStyle: this.layoutStyle(),\n      hasFeature: function (feature) {\n        switch (feature) {\n          case \"dom-manipulation\":\n            return true;\n\n          case \"layout-changes\":\n            return true;\n\n          case \"touch-events\":\n            return true;\n\n          case \"mouse-events\":\n            return true;\n\n          case \"keyboard-events\":\n            return true;\n\n          case \"spine-scripting\":\n            return false;\n\n          default:\n            return false;\n        }\n      }\n    };\n    return navigator.epubReadingSystem;\n  }\n\n  destroy() {\n    // this.document.removeEventListener('transitionend', this._resizeCheck);\n    this.removeListeners();\n  }\n\n}\n\n(0, _eventEmitter.default)(Contents.prototype);\nvar _default = Contents;\nexports.default = _default;"]},"metadata":{},"sourceType":"script"}